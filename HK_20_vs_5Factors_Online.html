
<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>20檔港股 × 5因子（Google Sheet CSV 版）</title>
<style>
  :root {
    --bg:#0b0e11; --panel:#12161c; --text:#e8eef5; --muted:#9aa4af;
    --green:#173a26; --green-bd:#2c8a54; --green-fg:#8be6b4;
    --range:#2b2f36; --range-bd:#42474f; --range-fg:#cbd4df;
    --red:#3a1717; --red-bd:#a33a3a; --red-fg:#ffb2b2;
    --amber:#d8a020; --line:#2a2f36; --card:#151a21;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Noto Sans','PingFang SC','Microsoft Yahei',sans-serif}
  header{padding:16px 20px;border-bottom:1px solid var(--line);display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  header h1{margin:0;font-size:18px;font-weight:600}
  .badge{padding:4px 10px;border-radius:999px;font-weight:600;font-size:12px}
  .green{background:var(--green);color:var(--green-fg);border:1px solid var(--green-bd)}
  .red{background:var(--red);color:var(--red-fg);border:1px solid var(--red-bd)}
  .range{background:var(--range);color:var(--range-fg);border:1px solid var(--range-bd)}
  main{display:grid;grid-template-columns:1.3fr 1fr;gap:14px;padding:14px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:12px;position:relative}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{background:#1a1f27;border:1px solid #2f3540;padding:6px 10px;border-radius:10px;color:#dfe7f0;cursor:pointer}
  .btn:hover{background:#202734}
  input[type="text"]{min-width:340px;max-width:680px;width:100%;padding:6px 10px;border-radius:8px;border:1px solid var(--line);background:#0f1318;color:#dfe7f0}
  .controls label{color:var(--muted);font-size:12px}
  .slider-wrap{display:grid;grid-template-columns:1fr;gap:10px;margin-top:6px}
  .slider{width:100%}
  #chart{width:100%;height:380px;background:#0f1318;border:1px solid var(--line);border-radius:12px;position:relative}
  .legend{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
  .legend span{font-size:12px;color:var(--muted)}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px dashed #2a2f36;padding:8px 6px;font-size:13px}
  th{text-align:left;color:var(--muted)}
  .pill{padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #2e343b;background:#141920;color:#cbd4df}
  .pill.green{border-color:var(--green-bd);background:#183023;color:var(--green-fg)}
  .pill.red{border-color:var(--red-bd);background:#2b1616;color:var(--red-fg)}
  .info{position:absolute;right:8px;top:8px;background:rgba(20,25,32,.75);border:1px solid var(--line);padding:6px 8px;border-radius:8px;font-size:12px;color:#cfd9e5}
  .warn{color:#ffb36b}
</style>
</head>
<body>
<header>
  <h1>20檔港股 × 5因子（Google Sheet CSV）</h1>
  <div id="fusedBadge" class="badge range">Status: Range</div>
  <button id="resetBtn" class="btn">重設</button>
</header>

<main>
  <section class="card">
    <div class="row" style="gap:6px;margin-bottom:8px;">
      <label style="font-size:12px;color:#9aa4af;">因子 CSV URL：</label>
      <input id="factorsUrl" type="text" value="https://docs.google.com/spreadsheets/d/e/2PACX-1vRWwBu0OBPdKNBOgEkHe31yFFYdkrmRRvc-kBspAuIADJH_5MfA0vca9JTrCptZfd48JMJe3ktYMUsX/pub?output=csv">
      <button id="loadFactors" class="btn">載入因子</button>
      <span id="loadHint" class="warn" style="display:none;">載入中…</span>
    </div>
    <div id="chart"></div>
    <div class="legend">
      <span>— Fused；分區：Green ≥ 0.5 / Red ≤ -0.5（縱向）</span>
      <span>— Amber (±0.3) <b>上方</b>圓點、Red (±0.5) <b>下方</b>圓點</span>
    </div>
  </section>

  <section class="card">
    <h3 style="margin:4px 0 6px;">窗口 & 顯示</h3>
    <div class="slider-wrap">
      <div class="row"><label>Start</label><input id="startSlider" class="slider" type="range" min="0" max="100" value="0"></div>
      <div class="row"><label>Mid</label><input id="midSlider" class="slider" type="range" min="0" max="100" value="50"></div>
      <div class="row"><label>End</label><input id="endSlider" class="slider" type="range" min="0" max="100" value="100"></div>
    </div>
    <div class="row" style="margin-top:8px;">
      <button class="btn q" data-q="365">1Y</button>
      <button class="btn q" data-q="180">6M</button>
      <button class="btn q" data-q="90">3M</button>
      <button class="btn q" data-q="30">1M</button>
      <button class="btn q" data-q="all">All</button>
    </div>
    <div class="row" style="margin-top:8px;">
      <label>門檻：</label>
      <span>Green ≥</span><input id="thrGreen" type="number" step="0.05" value="0.5" style="width:80px;">
      <span>Red ≤</span><input id="thrRed" type="number" step="0.05" value="-0.5" style="width:80px;">
      <label><input id="showBG" type="checkbox" checked> 分區</label>
      <label><input id="showFused" type="checkbox" checked> 顯示 Fused</label>
    </div>
  </section>

  <section class="card" style="grid-column:1 / span 2;">
    <h3 style="margin:4px 0 6px;">20檔股票強弱排名（窗口內計算）</h3>
    <div class="row" style="gap:6px;margin-bottom:10px;">
      <label style="font-size:12px;color:#9aa4af;">股票 CSV（本機檔）：</label>
      <input id="stockCsv" type="file" accept=".csv">
      <button id="exportScores" class="btn">導出當前排名 CSV</button>
    </div>
    <table id="rankTable">
      <thead><tr>
        <th>#</th><th>股票</th><th>代碼</th>
        <th>RS(1M-對HSI)</th><th>RS(3M-對HSI)</th><th>Corr(Fused)</th>
        <th>Score</th><th>狀態</th>
      </tr></thead>
      <tbody></tbody>
    </table>
  </section>
</main>

<script>
const MIN_WIN=5, ONE_MONTH=30;
const DEFAULTS={showBG:true,showFused:true,thrGreen:0.5,thrRed:-0.5};
const STOCKS=[
  {code:'00700',name:'Tencent'},{code:'09988',name:'Alibaba'},{code:'03690',name:'Meituan'},{code:'01024',name:'Kuaishou'},
  {code:'01810',name:'Xiaomi'},{code:'00388',name:'HKEX'},{code:'09618',name:'JD.com'},{code:'02318',name:'Ping An'},
  {code:'03988',name:'Bank of China'},{code:'00939',name:'CCB'},{code:'09888',name:'Baidu'},{code:'00005',name:'HSBC'},
  {code:'01211',name:'BYD'},{code:'09999',name:'NetEase'},{code:'09626',name:'Bilibili'},{code:'09961',name:'Trip.com'},
  {code:'01398',name:'ICBC'},{code:'00857',name:'PetroChina'},{code:'00883',name:'CNOOC'},{code:'00981',name:'SMIC'}
];

function parseCSV(text){
  const lines=text.trim().split(/\r?\n/);
  const header=lines[0].split(',').map(s=>s.trim());
  const rows=lines.slice(1).map(line=>{
    const parts=[];let cur='',q=false;
    for(let i=0;i<line.length;i++){const ch=line[i]; if(ch=='"'){q=!q;continue} if(ch==','&&!q){parts.push(cur);cur='';continue} cur+=ch;}
    parts.push(cur); return parts;
  });
  return {header,rows};
}
function toDate(s){const d=new Date(s);return isNaN(d)?null:d;}
function num(x){const v=parseFloat(x);return isNaN(v)?null:v;}
function seriesFromCsv(parsed){
  const {header,rows}=parsed;
  const idxDate=header.findIndex(h=>h.toLowerCase()==='date'||h==='Date');
  if(idxDate<0) throw new Error('找不到 Date 欄位');
  const cols=header.map((h,i)=>({name:h,index:i}));
  const out=rows.map(r=>{const d=toDate(r[idxDate]); const o={Date:d}; cols.forEach(({name,index})=>{if(name!=='Date') o[name]=num(r[index]);}); return o;})
                 .filter(o=>o.Date).sort((a,b)=>a.Date-b.Date);
  return out;
}
function column(x,col){return x.map(r=>r[col]??null);}
function colnames(x){return Object.keys(x[0]||{}).filter(k=>k!=='Date');}
function clamp(v,min,max){return Math.max(min,Math.min(max,v));}
function percentRank(arr,v){const valid=arr.filter(x=>x!=null).slice().sort((a,b)=>a-b);if(valid.length===0)return null;let i=0;while(i<valid.length&&valid[i]<=v)i++;return i/valid.length;}
function zFromPercentile(p){return p==null?null:(2*(p-0.5));}
function pctChange(arr){const out=[null];for(let i=1;i<arr.length;i++){const a=arr[i-1],b=arr[i];out.push((a==null||b==null)?null:(b-a)/a);}return out;}
function rollingReturn(arr,win){const out=Array(arr.length).fill(null);for(let i=win;i<arr.length;i++){const a=arr[i-win],b=arr[i];out[i]=(a==null||b==null)?null:(b/a-1);}return out;}
function corr(a,b){const xs=[],ys=[];for(let i=0;i<a.length&&i<b.length;i++){if(a[i]==null||b[i]==null)continue;xs.push(a[i]);ys.push(b[i]);}const n=xs.length;if(n<3)return null;const mean=v=>v.reduce((s,x)=>s+x,0)/v.length;const mx=mean(xs),my=mean(ys);let num=0,dx=0,dy=0;for(let i=0;i<n;i++){const X=xs[i]-mx,Y=ys[i]-my;num+=X*Y;dx+=X*X;dy+=Y*Y;}const den=Math.sqrt(dx*dy);return den===0?0:num/den;}
function fusedStatus(x,thrG,thrR){ if(x==null) return 'Range'; if(x>=thrG) return 'Green'; if(x<=thrR) return 'Red'; return 'Range'; }

let factorsSeries=[], Fdates=[], Fused=[], HSI=[];
let startIdx=0, endIdx=0;

async function loadFactors(url){
  const hint=document.getElementById('loadHint'); hint.style.display='inline';
  try{
    const bust=(url.includes('?')?'&':'?') + 't=' + Date.now();
    let res;
    try{
      res = await fetch(url + bust);
      if(!res.ok) throw new Error('HTTP '+res.status);
    }catch(err){
      res = await fetch('https://cors.isomorphic-git.org/' + url + bust);
      if(!res.ok) throw new Error('HTTP '+res.status);
    }
    const text=await res.text();
    const parsed=parseCSV(text);
    factorsSeries=seriesFromCsv(parsed);
    Fdates=factorsSeries.map(r=>r.Date);
    Fused=column(factorsSeries,'Fused');
    HSI=column(factorsSeries,'HSI');
    startIdx=Math.max(0, Fdates.length - Math.max(MIN_WIN, Math.min(ONE_MONTH, Fdates.length-1)));
    endIdx=Fdates.length-1;
    syncSlidersToWindow();
    updateAll();
  }catch(e){
    alert('載入因子 CSV 失敗：' + e.message + '\n請確認 Google Sheet 已公開發佈為 CSV。');
  }finally{
    hint.style.display='none';
  }
}

function updateBadge(idx){
  const thrG=+document.getElementById('thrGreen').value, thrR=+document.getElementById('thrRed').value;
  const st=fusedStatus(Fused[idx],thrG,thrR);
  const b=document.getElementById('fusedBadge');
  b.textContent='Status: '+st; b.className='badge '+(st==='Green'?'green':(st==='Red'?'red':'range'));
}
function applySliders(){
  const n=Fdates.length;
  const s=+document.getElementById('startSlider').value/100;
  const m=+document.getElementById('midSlider').value/100;
  const e=+document.getElementById('endSlider').value/100;
  let a=Math.round(s*(n-1)), c=Math.round(m*(n-1)), b=Math.round(e*(n-1));
  if(b<=a) b=a+1;
  let L=b-a+1; if(L<MIN_WIN){L=MIN_WIN; b=a+L-1;}
  c=clamp(c,Math.floor(L/2),(n-1)-Math.floor(L/2));
  if(a>c-Math.floor(L/2)) a=c-Math.floor(L/2);
  if(b<c+Math.floor(L/2)) b=c+Math.floor(L/2);
  a=clamp(a,0,n-2); b=clamp(b,a+1,n-1);
  startIdx=a; endIdx=b; updateAll();
}
function syncSlidersToWindow(){
  const n=Fdates.length, L=endIdx-startIdx+1, c=startIdx+Math.floor(L/2);
  document.getElementById('startSlider').value=Math.round(100*startIdx/(n-1));
  document.getElementById('endSlider').value  =Math.round(100*endIdx/(n-1));
  document.getElementById('midSlider').value  =Math.round(100*c/(n-1));
}
function drawChart(){
  const el=document.getElementById('chart'); if(!Fdates.length){el.innerHTML='<div style="padding:12px;color:#9aa4af">請先載入因子 CSV</div>'; return;}
  const W=el.clientWidth, H=el.clientHeight, pad=8, minY=-1, maxY=1;
  const svgNS='http://www.w3.org/2000/svg'; el.innerHTML=''; const svg=document.createElementNS(svgNS,'svg');
  svg.setAttribute('width',W); svg.setAttribute('height',H); el.appendChild(svg);
  const info=document.createElement('div'); info.className='info'; el.appendChild(info);
  const X=(i)=> pad+(W-2*pad)*((i-startIdx)/(endIdx-startIdx||1));
  const Y=(v)=> pad+(H-2*pad)*(1-(v-minY)/(maxY-minY));
  const thrG=+document.getElementById('thrGreen').value, thrR=+document.getElementById('thrRed').value, amber=0.3;

  if(document.getElementById('showBG').checked){
    let runStart=startIdx, cur=fusedStatus(Fused[startIdx],thrG,thrR);
    for(let i=startIdx+1;i<=endIdx;i++){ const st=fusedStatus(Fused[i],thrG,thrR); if(st!==cur){ band(runStart,i-1,cur); runStart=i; cur=st; } }
    band(runStart,endIdx,cur);
  }
  function band(l,r,st){
    const x1=X(l), x2=X(r)+1;
    const rect=document.createElementNS(svgNS,'rect');
    rect.setAttribute('x',x1); rect.setAttribute('y',0);
    rect.setAttribute('width',Math.max(1,x2-x1)); rect.setAttribute('height',H);
    let fill='rgba(43,47,54,0.18)'; if(st==='Green') fill='rgba(23,58,38,0.28)'; if(st==='Red') fill='rgba(58,23,23,0.28)';
    rect.setAttribute('fill',fill); svg.appendChild(rect);
  }

  [thrG,thrR,amber,-amber].forEach((lv,idx)=>{ const y=Y(lv); const ln=document.createElementNS(svgNS,'line');
    ln.setAttribute('x1',0); ln.setAttribute('x2',W); ln.setAttribute('y1',y); ln.setAttribute('y2',y);
    ln.setAttribute('stroke','#566070'); ln.setAttribute('stroke-dasharray', idx<2 ? '0' : '6,6'); ln.setAttribute('stroke-width',1); svg.appendChild(ln);
  });

  if(document.getElementById('showFused').checked){
    let d=''; for(let i=startIdx;i<=endIdx;i++){ const v=Fused[i]; if(v==null) continue; const x=X(i), y=Y(v); d+=(i===startIdx?'M':'L')+x+' '+y+' '; }
    const path=document.createElementNS(svgNS,'path'); path.setAttribute('d',d.trim()); path.setAttribute('fill','none'); path.setAttribute('stroke','#cfe8ff'); path.setAttribute('stroke-width','1.5'); svg.appendChild(path);
  }

  function crosses(level){
    const arr=[]; let prev=Fused[startIdx-1];
    for(let i=startIdx;i<=endIdx;i++){ const cur=Fused[i];
      if(prev!=null && cur!=null){ if((prev<level && cur>=level) || (prev>level && cur<=level)) arr.push(i); }
      prev=cur;
    } return arr;
  }
  const ambers=crosses(0.3), redsTop=crosses(0.5), redsBottom=crosses(-0.5);
  function dotAt(i,color,top){
    const cx=X(i), cy=top?(pad+5):(H-pad-5);
    const c=document.createElementNS(svgNS,'circle'); c.setAttribute('cx',cx); c.setAttribute('cy',cy);
    c.setAttribute('r',3.2); c.setAttribute('fill',color); c.setAttribute('stroke','#0f1318'); c.setAttribute('stroke-width','1');
    const d=new Date(Fdates[i]).toISOString().slice(0,10); const val=(Fused[i]!=null)?Fused[i].toFixed(3):'NA';
    const typ=color==='#d8a020'?'Amber':'Red'; c.title=`${d} • Fused=${val} • ${fusedStatus(Fused[i],thrG,thrR)} • ${typ}`;
    svg.appendChild(c);
  }
  ambers.forEach(i=>dotAt(i,'#d8a020',true));
  redsTop.forEach(i=>dotAt(i,'#d24c4c',false));
  redsBottom.forEach(i=>dotAt(i,'#d24c4c',false));

  const endD=new Date(Fdates[endIdx]).toISOString().slice(0,10), startD=new Date(Fdates[startIdx]).toISOString().slice(0,10);
  const last=Fused[endIdx]; const st=fusedStatus(last,thrG,thrR);
  info.textContent = `${startD} → ${endD} ｜ Fused=${(last??'NA')&&last.toFixed?last.toFixed(3):'NA'} ｜ ${st}`;

  updateBadge(endIdx);
}

// 強弱分（本機股票 CSV）
let stocksSeries=null;
function colnamesOf(series){return Object.keys(series[0]||{}).filter(k=>k!=='Date');}
function loadStocksFromText(text){
  const parsed=parseCSV(text); const series=seriesFromCsv(parsed);
  const names=colnamesOf(series); const map={}; names.forEach(n=>map[n]=normalizeCode(n));
  series.forEach(r=>{names.forEach(n=>{if(n!=='Date'){r[map[n]]=r[n]; delete r[n];}})});
  stocksSeries=series; updateAll();
}
function normalizeCode(h){let x=h.trim().toUpperCase(); x=x.replace('.HK','').replace(/^0+/,''); if(x.length<=3)x=x.padStart(3,'0'); return x.padStart(5,'0');}

function computeScores(){
  if(!stocksSeries||!Fdates.length) return [];
  const i0=startIdx,i1=endIdx,n=i1-i0+1;
  const L1=Math.max(MIN_WIN,Math.min(ONE_MONTH,n-1));
  const L3=Math.max(MIN_WIN,Math.min(90,n-1));
  const thrG=+document.getElementById('thrGreen').value, thrR=+document.getElementById('thrRed').value;
  const FusedWin=Fused.slice(i0,i1+1), HSIWin=HSI.slice(i0,i1+1);
  const dToIdxF=new Map(Fdates.map((d,i)=>[+d,i]));
  const allRS1=[], allRS3=[], allCorr=[], tmp={};
  const codes=STOCKS.map(s=>s.code);
  codes.forEach(code=>{
    const stock=Fdates.map(()=>null);
    for(const row of stocksSeries){ const di=dToIdxF.get(+row.Date); if(di!=null && row[code]!=null) stock[di]=row[code]; }
    const win=stock.slice(i0,i1+1);
    const r1=rollingReturn(win,L1), r3=rollingReturn(win,L3);
    const h1=rollingReturn(HSIWin,L1), h3=rollingReturn(HSIWin,L3);
    const RS1=(r1.at(-1)!=null && h1.at(-1)!=null)?(r1.at(-1)-h1.at(-1)):null;
    const RS3=(r3.at(-1)!=null && h3.at(-1)!=null)?(r3.at(-1)-h3.at(-1)):null;
    const ret=pctChange(win), cor=corr(ret,FusedWin);
    tmp[code]={RS1,RS3,cor}; allRS1.push(RS1); allRS3.push(RS3); allCorr.push(cor);
  });
  const scores=codes.map(code=>{
    const {RS1,RS3,cor}=tmp[code];
    const s1=zFromPercentile(RS1==null?null:percentRank(allRS1,RS1));
    const s3=zFromPercentile(RS3==null?null:percentRank(allRS3,RS3));
    const sc=zFromPercentile(cor==null?null:percentRank(allCorr,cor));
    const comp=((s1??0)*0.4 + (s3??0)*0.4 + (sc??0)*0.2);
    const state=comp>=thrG?'Strong':(comp<=thrR?'Weak':'Neutral');
    return {code,RS1,RS3,cor,score:comp,state};
  });
  scores.forEach(s=>{ s.name=(STOCKS.find(x=>x.code===s.code)||{}).name || s.code; });
  scores.sort((a,b)=>(b.score??-1)-(a.score??-1));
  return scores;
}
function renderTable(scores){
  const tb=document.querySelector('#rankTable tbody'); tb.innerHTML='';
  scores.forEach((r,i)=>{
    const pill=r.state==='Strong'?'pill green':(r.state==='Weak'?'pill red':'pill');
    const tr=document.createElement('tr'); tr.innerHTML=`<td>${i+1}</td><td>${r.name}</td><td>${r.code}</td>
    <td>${r.RS1==null?'':(r.RS1*100).toFixed(2)+'%'} </td>
    <td>${r.RS3==null?'':(r.RS3*100).toFixed(2)+'%'} </td>
    <td>${r.cor==null?'':r.cor.toFixed(3)} </td>
    <td>${r.score==null?'':r.score.toFixed(3)} </td>
    <td><span class="${pill}">${r.state}</span></td>`;
    tb.appendChild(tr);
  });
}
function exportScoresCSV(scores){
  const header=['Rank','Name','Code','RS1M_vs_HSI','RS3M_vs_HSI','Corr_Fused','Score','State'];
  const rows=scores.map((r,i)=>[i+1,r.name,r.code,r.RS1??'',r.RS3??'',r.cor??'',r.score??'',r.state]);
  const text=[header.join(','),...rows.map(a=>a.join(','))].join('\n');
  const blob=new Blob([text],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='HK20_vs_5factors_scores.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

function updateAll(){ drawChart(); if(stocksSeries) renderTable(computeScores()); }
document.getElementById('startSlider').addEventListener('input',applySliders);
document.getElementById('midSlider').addEventListener('input',applySliders);
document.getElementById('endSlider').addEventListener('input',applySliders);
document.querySelectorAll('.q').forEach(b=>b.addEventListener('click',()=>{ const q=b.dataset.q; if(!Fdates.length) return;
  if(q==='all'){startIdx=0; endIdx=Fdates.length-1;} else { const days=parseInt(q,10), n=Fdates.length, d=Math.max(MIN_WIN,Math.min(days,n-1)); endIdx=n-1; startIdx=Math.max(0,n-1-d); }
  syncSlidersToWindow(); updateAll();
}));
document.getElementById('thrGreen').addEventListener('change',updateAll);
document.getElementById('thrRed').addEventListener('change',updateAll);
document.getElementById('showBG').addEventListener('change',updateAll);
document.getElementById('showFused').addEventListener('change',updateAll);
document.getElementById('resetBtn').addEventListener('click',()=>{ document.getElementById('thrGreen').value=DEFAULTS.thrGreen; document.getElementById('thrRed').value=DEFAULTS.thrRed; document.getElementById('showBG').checked=true; document.getElementById('showFused').checked=true; if(Fdates.length){ endIdx=Fdates.length-1; startIdx=Math.max(0,endIdx-(ONE_MONTH-1)); syncSlidersToWindow(); updateAll(); } });
document.getElementById('loadFactors').addEventListener('click',()=>{ const url=document.getElementById('factorsUrl').value.trim(); if(url) loadFactors(url); });
document.getElementById('stockCsv').addEventListener('change',(ev)=>{ const f=ev.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=>loadStocksFromText(r.result); r.readAsText(f); });

// 啟動
loadFactors(document.getElementById('factorsUrl').value);
</script>
</body>
</html>
