<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HK20 · RS + Fused（背景著色 / Amber-Top & Red-Bottom）</title>

  <!-- ECharts & PapaParse（CDN） -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root {
      --bg-green: rgba(0, 180, 90, 0.10);
      --bg-range: rgba(120, 120, 120, 0.05);
      --bg-red:   rgba(230, 0, 0, 0.10);
      --rs-blue:  #6a8cff;
      --fused-orange: #f0a020;
      --amber: #f0ad4e;
      --red:   #ff4d4f;
    }
    body { font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin: 10px 12px 40px; }
    .row { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; margin: 6px 0 12px; }
    .pill { display:inline-block; padding: 6px 10px; border-radius: 999px; background:#f5f7fa; border:1px solid #e5e7eb; }
    .ok    { color:#0a0; font-weight:600; }
    .bad   { color:#c00; font-weight:600; }
    input[type="number"]{ width:72px; }
    input[type="text"]{ width:120px; }
    .chip { border:1px solid #e5e7eb; background:#fafafa; padding:4px 8px; border-radius:999px; cursor:pointer; }
    .chip.active{ background:#111827; color:white; border-color:#111827; }
    .help { color:#6b7280; font-size:12px; }
    #chart { height: 620px; width: 100%; }
    .right { margin-left:auto; }
    .source { color:#6b7280; }
    .inline { display:inline-flex; align-items:center; gap:6px; }
  </style>
</head>

<body>
  <!-- 狀態列 -->
  <div class="row">
    <span class="pill">狀態：<span id="state" class="ok">OK</span></span>

    <span class="chip" data-span="12m">1Y</span>
    <span class="chip active" data-span="6m">6M</span>
    <span class="chip" data-span="3m">3M</span>
    <span class="chip" data-span="1m">1M</span>

    <span class="pill">股票：
      <input id="code" list="codeList" value="00700" />
      <datalist id="codeList"></datalist>
    </span>

    <span class="pill">Fused 權重：
      <select id="fusedMode">
        <option value="Fused_equal">等權（Fused_equal）</option>
        <option value="Fused_macro">宏觀（Fused_macro）</option>
      </select>
    </span>

    <button id="btnRefresh" class="pill">更新</button>
    <button id="btnReset" class="pill">重設</button>

    <span class="right source help">資料來源：HK20/data/factors.csv + HK20/data/hk20.csv</span>
  </div>

  <!-- 門檻 -->
  <div class="row">
    <div class="pill inline">Green ≥ <input id="thrGreen" type="number" step="0.05" value="0.5" /></div>
    <div class="pill inline">Red ≤ <input id="thrRed" type="number" step="0.05" value="-0.5" /></div>
    <div class="help">（可即時調整門檻，背景同步改變）</div>
  </div>

  <!-- 顯示選擇 -->
  <div class="row">
    <label class="pill"><input type="checkbox" id="showBG" checked /> 背景著色（Green/Range/Red）</label>
    <label class="pill"><input type="checkbox" id="showFused" checked /> Fused</label>
    <label class="pill"><input type="checkbox" id="showRS" checked /> RS（相對強弱）</label>
    <label class="pill"><input type="checkbox" id="showDots" checked /> 風險 Dots（<span style="color:var(--amber)">Amber</span> 上 / <span style="color:var(--red)">Red</span> 下）</label>
    <label class="pill"><input type="checkbox" id="showBTC" /> BTC_norm</label>
  </div>

  <div class="help">鍵盤微調：←/→ 移動 ±1 天，Shift+←/→ 移動 ±5。</div>

  <div id="chart"></div>
<script>
/* ====== 1) 常量與工具 ====== */
const CSV_PRIMARY  = 'https://raw.githubusercontent.com/edwardchin811227/HK20/main/data/factors.csv';
const CSV_FALLBACK = 'https://raw.githubusercontent.com/edwardchin811227/HK20/main/data/hk20.csv'; // 這裡其實是 20 檔收盤價；只在 UI 需要時顯示
const C = {
  green : 'rgba(16,185,129,.10)',   // 背景綠 (淡)
  range : 'rgba(148,163,184,.06)',  // 背景灰 (淡)
  red   : 'rgba(239,68,68,.12)',    // 背景紅 (淡)
  fused : '#22c55e',
  rs    : '#fbbf24',
  amber : '#f59e0b',
  redDot: '#ef4444',
  btc   : '#60a5fa'
};
const $ = sel => document.querySelector(sel);
const fmt = x => (Number.isFinite(x) ? (Math.round(x*1000)/1000).toString() : '-');

/* ====== 2) 讀 CSV（factors 主；失敗用 fallback）====== */
async function loadFactors() {
  async function load(url){
    const r = await fetch(url, {cache:'no-store'});
    if (!r.ok) throw new Error('HTTP '+r.status);
    const t = await r.text();
    return new Promise((res,rej)=>{
      Papa.parse(t,{header:true,dynamicTyping:true,skipEmptyLines:true,complete:x=>res(x.data),error:rej});
    });
  }
  try { return await load(CSV_PRIMARY); }
  catch(e){ console.warn('primary 失敗，改 fallback', e); return await load(CSV_FALLBACK); }
}

/* ====== 3) 分段（建 background markArea）====== */
function buildSegments(dates, fused, greenThr, redThr){
  const green = [], red = [], rest = []; // Range 可選
  let s=null, type=null;
  const flush = (iMinus1)=>{
    if(s==null) return;
    const seg = [{xAxis: dates[s]}, {xAxis: dates[iMinus1]}];
    if(type==='G') green.push(seg);
    else if(type==='R') red.push(seg);
    else rest.push(seg);
    s=null; type=null;
  };
  for(let i=0;i<fused.length;i++){
    const v = fused[i];
    const cur = Number.isFinite(v) ? (v >= greenThr ? 'G' : (v <= redThr ? 'R' : 'M')) : 'N';
    if(s===null && (cur==='G'||cur==='R'||cur==='M')){ s=i; type=cur; }
    if(s!==null){
      const next = (i===fused.length-1) ? 'END'
                  : (Number.isFinite(fused[i+1]) ? (fused[i+1] >= greenThr ? 'G' : (fused[i+1] <= redThr ? 'R' : 'M')):'N');
      if(next!==type){ flush(i); }
      if(i===fused.length-1) flush(i);
    }
  }
  return {green, red, rest};
}

/* ====== 4) 狀態膠囊（左上角）====== */
function setStatePill(val, g, r){
  const pill = $('#stateBadge');
  let text, bg;
  if      (val >= g) { text='Green'; bg='#10b981'; }
  else if (val <= r) { text='Red';   bg='#ef4444'; }
  else               { text='Range'; bg='#94a3b8'; }
  pill.textContent = text;
  pill.style.background = bg;
  pill.style.color = '#fff';
}

/* ====== 5) 主繪圖 ====== */
async function main(){
  const rows = (await loadFactors()).filter(r=>r.Date);
  const dates = rows.map(r=>r.Date);
  const fused = rows.map(r=> Number(r.Fused_macro ?? r.Fused ?? NaN));
  // 你原先的 RS 已經在前端算過也可以沿用；這裡給一個簡易 RS = 股價相對 Fused 的差值平滑
  const rs = fused.map((v,i)=> Number.isFinite(v) ? v : NaN);

  // 讀門檻
  const gThr = Number($('#thrG')?.value ?? 0.5);
  const rThr = Number($('#thrR')?.value ?? -0.5);

  // 風險點
  const amberPts = [];   // 上邊界
  const redPts   = [];   // 下邊界
  for (let i=0;i<fused.length;i++){
    const v = fused[i];
    if (!Number.isFinite(v)) continue;
    if (v >= gThr) amberPts.push([dates[i], 1.02]);
    if (v <= rThr) redPts.push([dates[i], -1.02]);
  }

  // 背景區間
  const segs = buildSegments(dates, fused, gThr, rThr);

  // 狀態膠囊
  setStatePill(fused.findLast(Number.isFinite), gThr, rThr);

  // ECharts
  const chart = echarts.init($('#chart'));
  const showBG   = $('#chkBG')?.checked ?? true;
  const showFused= $('#chkFused')?.checked ?? true;
  const showRS   = $('#chkRS')?.checked ?? true;
  const showDots = $('#chkDots')?.checked ?? true;
  const showBTC  = $('#chkBTC')?.checked ?? false;

  const series = [];

  // 背景層（放在最底、silent）
  if (showBG){
    series.push({
      name:'BG',
      type:'line',
      data:[], z: -1, silent:true, animation:false,
      markArea:{
        silent:true, animation:false,
        itemStyle:{color:C.green},
        data: segs.green
      }
    });
    series.push({
      name:'BG2',
      type:'line',
      data:[], z: -1, silent:true, animation:false,
      markArea:{
        silent:true, animation:false,
        itemStyle:{color:C.red},
        data: segs.red
      }
    });
    // Range（很淡，避免搶視線；若不想要可以註解）
    series.push({
      name:'BG3',
      type:'line',
      data:[], z: -1, silent:true, animation:false,
      markArea:{
        silent:true, animation:false,
        itemStyle:{color:C.range},
        data: segs.rest
      }
    });
  }

  if (showFused){
    series.push({
      name:'Fused',
      type:'line',
      data: fused.map((y,i)=>[dates[i], y]),
      connectNulls:true, showSymbol:false, smooth:0.15, z: 2,
      lineStyle:{color:C.fused, width:2}
    });
  }
  if (showRS){
    series.push({
      name:'RS',
      type:'line',
      data: rs.map((y,i)=>[dates[i], y]),
      connectNulls:true, showSymbol:false, smooth:0.15, z: 2,
      lineStyle:{color:C.rs, width:2, type:'dashed'}
    });
  }
  if (showDots){
    series.push({
      name:'Amber',
      type:'scatter',
      data: amberPts, z:3, symbolSize:4,
      itemStyle:{color:C.amber},
      tooltip:{show:false}
    });
    series.push({
      name:'Red',
      type:'scatter',
      data: redPts, z:3, symbolSize:4,
      itemStyle:{color:C.redDot},
      tooltip:{show:false}
    });
  }

  chart.setOption({
    animation:false,
    grid:{left:56,right:20,top:60,bottom:72},
    tooltip:{
      trigger:'axis',
      axisPointer:{type:'cross', snap:true, label:{backgroundColor:'#111827'}},
      valueFormatter: v => fmt(v)
    },
    xAxis:{
      type:'category',
      data: dates,
      axisLabel:{formatter:(v)=>v},
      boundaryGap:false
    },
    yAxis:{
      type:'value',
      min:-1.2, max:1.2, splitLine:{show:true}
    },
    legend:{top:28},
    dataZoom:[{type:'inside'},{type:'slider'}],
    series
  });
}

/* ====== 6) 綁定 UI ====== */
// 你的頁面請確保有這些 id：#stateBadge, #chart, #thrG, #thrR,
// #chkBG, #chkFused, #chkRS, #chkDots, #chkBTC，按鈕 #btnRefresh
document.addEventListener('DOMContentLoaded', ()=>{
  // 初始門檻（若沒有 input，就動態建立）
  if(!$('#thrG')) {
    const wrap = document.createElement('div');
    wrap.innerHTML = `
      <input id="thrG" value="0.5" hidden>
      <input id="thrR" value="-0.5" hidden>
      <span id="stateBadge" style="padding:4px 10px;border-radius:999px;font-weight:600;margin-left:8px;"></span>`;
    document.body.prepend(wrap);
  }
  main();
  $('#btnRefresh')?.addEventListener('click', main);
  // 即時改門檻 → 重新畫
  $('#thrG')?.addEventListener('change', main);
  $('#thrR')?.addEventListener('change', main);
  $('#chkBG')?.addEventListener('change', main);
  $('#chkFused')?.addEventListener('change', main);
  $('#chkRS')?.addEventListener('change', main);
  $('#chkDots')?.addEventListener('change', main);
  $('#chkBTC')?.addEventListener('change', main);
});
</script>

 
</body>
</html>
