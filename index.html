<script src="https://cdn.jsdelivr.net/npm/papaparse@5/dist/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<script>
const _ts = `?v=${Date.now()}`;
const SOURCES = [
  'https://edwardchin811227.github.io/HK20/data/factors.csv' + _ts,
  'https://cdn.jsdelivr.net/gh/edwardchin811227/HK20@main/data/factors.csv' + _ts,
  'https://raw.githubusercontent.com/edwardchin811227/HK20/main/data/factors.csv' + _ts,
];

function toNum(x){ const v = Number(x); return Number.isFinite(v) ? v : NaN; }

function pickFused(rows){
  // 1) 先用 Fused_macro
  let fused = rows.map(r => toNum(r.Fused_macro));
  if (fused.some(Number.isFinite)) return fused;
  // 2) 退化：等權平均五個 *_norm
  const cols = ["HSI_norm","HSTECH_norm","USDCNH_norm","VHSI_norm","BTC_norm"];
  fused = rows.map(r => {
    const xs = cols.map(c => toNum(r[c])).filter(Number.isFinite);
    return xs.length ? xs.reduce((a,b)=>a+b,0)/xs.length : NaN;
  });
  return fused;
}

async function loadCSV(){
  let lastErr;
  for (const url of SOURCES){
    try {
      const r = await fetch(url, {cache:'no-store'});
      if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
      const txt = await r.text();
      return new Promise((resolve,reject)=>{
        Papa.parse(txt, { header:true, dynamicTyping:true, complete: res => resolve(res.data), error: reject });
      });
    } catch(e){ lastErr = e; }
  }
  throw lastErr;
}

(async () => {
  const rows = (await loadCSV()).filter(r => r.Date); // 去掉空行
  // 轉成陣列
  const dates = rows.map(r => r.Date);
  const fused = pickFused(rows);
  // 找第一筆有效值（避開 min_periods 視窗未滿的 NaN 期）
  const firstValid = fused.findIndex(Number.isFinite);
  if (firstValid === -1){
    document.getElementById('msg').textContent = 'CSV 沒有可用數據（Fused / *_norm 全為空）。';
    return;
  }
  const d = dates.slice(firstValid), y = fused.slice(firstValid);

  // 畫最簡單的線（先驗證有值）
  const option = {
    tooltip:{trigger:'axis'},
    xAxis:{type:'category', data:d},
    yAxis:{type:'value'},
    dataZoom:[{type:'inside'},{type:'slider'}],
    series:[{type:'line', name:'Fused', data:y, connectNulls:true, showSymbol:false}]
  };
  echarts.init(document.getElementById('chart')).setOption(option);
})();
</script>
<div id="msg" style="color:#ffa940;margin:8px 0"></div>
<div id="chart" style="height:480px"></div>
