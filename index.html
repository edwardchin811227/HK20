<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>HK20 • Risk ON/OFF + RS</title>

<!-- ECharts + PapaParse -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
:root{
  --bg:#fff; --text:#111827; --muted:#6b7280; --border:#e5e7eb; --chip:#f3f4f6;
  --green:#10b981; --amber:#f59e0b; --red:#ef4444; --blue:#2563eb;
  --bg-green: rgba(16,185,129,.10);
  --bg-range: rgba(107,114,128,.10);
  --bg-red: rgba(239,68,68,.10);
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial}
.wrap{max-width:1280px;margin:0 auto;padding:16px}
.toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:10px}
.pill{padding:6px 12px;border-radius:999px;border:1px solid var(--border);background:#fff;display:inline-flex;gap:8px;align-items:center}
.pill input, .pill select{padding:6px 10px;border:1px solid var(--border);border-radius:8px;min-width:90px}
.pill .btn{padding:6px 10px;border:1px solid var(--border);border-radius:8px;background:#fff;cursor:pointer}
.pill .btn.active{background:#111827;color:#fff;border-color:#111827}
.badge{font-weight:700;border-radius:999px;padding:6px 12px}
.badge.green{color:#065f46;background:#d1fae5;border:1px solid #a7f3d0}
.badge.range{color:#334155;background:#e2e8f0;border:1px solid #cbd5e1}
.badge.red{color:#7f1d1d;background:#fee2e2;border:1px solid #fecaca}
.switch{display:flex;gap:8px;align-items:center;border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:#fff}
.chk{display:flex;gap:6px;align-items:center}
.legend{display:flex;gap:16px;align-items:center;color:var(--muted)}
.dot{width:8px;height:8px;border-radius:999px;display:inline-block;margin-right:6px}
.cGreen{background:var(--green)}
.cAmber{background:var(--amber)}
.cRed{background:var(--red)}
.cBlue{background:var(--blue)}
.cGray{background:var(--muted)}
.rs-bar{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0}
.rs-item{display:flex;align-items:center;gap:4px;padding:4px 8px;border:1px solid var(--border);border-radius:4px;background:#fff;font-size:12px}
.rs-item.green{color:var(--green);background:var(--bg-green)}
.rs-item.red{color:var(--red);background:var(--bg-red)}
.rs-item.range{color:var(--muted);background:var(--bg-range)}
.rs-item .val{font-weight:700}
#chart{height:560px}
small{color:var(--muted)}
hr{border:none;border-top:1px solid var(--border);margin:8px 0}
.loading{color:var(--amber);font-weight:bold}
.error{color:var(--red);font-weight:bold}
@media (max-width:720px){ #chart{height:480px} }
</style>
</head>
<body>
<div class="wrap">

  <!-- 狀態 -->
  <div class="toolbar">
    <span id="stateBadge" class="badge range">Range</span>
    <span id="loadingStatus" class="loading" style="display:none">載入中...</span>

    <div class="pill" id="rangeBtns">
      <button class="btn" data-range="1Y">1Y</button>
      <button class="btn active" data-range="6M">6M</button>
      <button class="btn" data-range="3M">3M</button>
      <button class="btn" data-range="1M">1M</button>
    </div>

    <div class="pill">
      <label>股票：</label>
      <select id="stockSel">
        <option>00700</option><option>09988</option><option>03690</option><option>01024</option><option>01810</option>
        <option>09618</option><option>00388</option><option>02318</option><option>03988</option><option>00939</option>
        <option>09888</option><option>00005</option><option>01211</option><option>09999</option><option>09626</option>
        <option>09961</option><option>01398</option><option>00857</option><option>00883</option><option>00981</option>
      </select>
    </div>

    <div class="pill">
      <label>Fused 權重：</label>
      <select id="wSel">
        <option value="equal">等權（Fused_equal）</option>
        <option value="macro">宏觀（Fused_macro）</option>
        <option value="aggressive_plus">Aggressive+（Fused_aggressive_plus）</option>
        <option value="conservative_plus">Conservative+（Fused_conservative_plus）</option>
      </select>
    </div>

    <div class="pill">
      <button id="btnRefresh" class="btn">更新</button>
      <button id="btnReset" class="btn">重設</button>
      <button id="btnFutu" class="btn">取得行情</button>
    </div>
  </div>

  <!-- 門檻 -->
  <div class="toolbar">
    <div class="pill">
      <label>Green ≥</label>
      <input id="thGreen" type="number" step="0.05" value="0.50">
      <label style="margin-left:8px">Red ≤</label>
      <input id="thRed" type="number" step="0.05" value="-0.5">
      <small>（即時調整門檻，背景同步改變）</small>
    </div>

    <div class="switch">
      <label class="chk"><input type="checkbox" id="bgChk" checked> 背景著色（Green/Range/Red）</label>
      <label class="chk"><input type="checkbox" id="fusedChk" checked> Fused</label>
      <label class="chk"><input type="checkbox" id="rsChk" checked> RS（相對強弱）</label>
      <label class="chk"><input type="checkbox" id="dotsChk" checked> 風險 Dots（<span style="color:var(--amber)">Amber 上</span> / <span style="color:var(--red)">Red 下</span>）</label>
    </div>
  </div>

  <div id="rsBar" class="rs-bar"></div>

  <div class="legend">
    <span><i class="dot cBlue"></i>Fused</span>
    <span><i class="dot cGray"></i>RS</span>
    <span><i class="dot cAmber"></i>Amber</span>
    <span><i class="dot cRed"></i>Red</span>
  </div>

  <div id="chart"></div>
  <small>資料來源：Google Sheets（即時更新）</small>
</div>

<script>
/* -----------------------------
 * 1) 設定：Google Sheets 資料來源
 * ----------------------------- */
const DATA_SOURCES = {
  factors: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRWwBu0OBPdKNBOgEkHe31yFFYdkrmRRvc-kBspAuIADJH_5MfA0vca9JTrCptZfd48JMJe3ktYMUsX/pub?gid=1962618135&single=true&output=csv',
  stocks: {
    '00700': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRWwBu0OBPdKNBOgEkHe31yFFYdkrmRRvc-kBspAuIADJH_5MfA0vca9JTrCptZfd48JMJe3ktYMUsX/pub?gid=1361803881&single=true&output=csv',
    '09988': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRWwBu0OBPdKNBOgEkHe31yFFYdkrmRRvc-kBspAuIADJH_5MfA0vca9JTrCptZfd48JMJe3ktYMUsX/pub?gid=1374161717&single=true&output=csv',
    '03690': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRWwBu0OBPdKNBOgEkHe31yFFYdkrmRRvc-kBspAuIADJH_5MfA0vca9JTrCptZfd48JMJe3ktYMUsX/pub?gid=237361273&single=true&output=csv',
    '01024': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRWwBu0OBPdKNBOgEkHe31yFFYdkrmRRvc-kBspAuIADJH_5MfA0vca9JTrCptZfd48JMJe3ktYMUsX/pub?gid=1640995641&single=true&output=csv',
    '01810': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRWwBu0OBPdKNBOgEkHe31yFFYdkrmRRvc-kBspAuIADJH_5MfA0vca9JTrCptZfd48JMJe3ktYMUsX/pub?gid=148317544&single=true&output=csv',
    '09618': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRWwBu0OBPdKNBOgEkHe31yFFYdkrmRRvc-kBspAuIADJH_5MfA0vca9JTrCptZfd48JMJe3ktYMUsX/pub?gid=1920724802&single=true&output=csv',
    '00388': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRWwBu0OBPdKNBOgEkHe31yFFYdkrmRRvc-kBspAuIADJH_5MfA0vca9JTrCptZfd48JMJe3ktYMUsX/pub?gid=1968548215&single=true&output=csv',
    '02318': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRWwBu0OBPdKNBOgEkHe31yFFYdkrmRRvc-kBspAuIADJH_5MfA0vca9JTrCptZfd48JMJe3ktYMUsX/pub?gid=78234286&single=true&output=csv',
    '03988': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRWwBu0OBPdKNBOgEkHe31yFFYdkrmRRvc-kBspAuIADJH_5MfA0vca9JTrCptZfd48JMJe3ktYMUsX/pub?gid=1420850916&single=true&output=csv',
    '00939': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRWwBu0OBPdKNBOgEkHe31yFFYdkrmRRvc-kBspAuIADJH_5MfA0vca9JTrCptZfd48JMJe3ktYMUsX/pub?gid=1350542650&single=true&output=csv',
    '09888': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRWwBu0OBPdKNBOgEkHe31yFFYdkrmRRvc-kBspAuIADJH_5MfA0vca9JTrCptZfd48JMJe3ktYMUsX/pub?gid=21209291&single=true&output=csv',
    '00005': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRWwBu0OBPdKNBOgEkHe31yFFYdkrmRRvc-kBspAuIADJH_5MfA0vca9JTrCptZfd48JMJe3ktYMUsX/pub?gid=1226474041&single=true&output=csv',
    '01211': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRWwBu0OBPdKNBOgEkHe31yFFYdkrmRRvc-kBspAuIADJH_5MfA0vca9JTrCptZfd48JMJe3ktYMUsX/pub?gid=167421362&single=true&output=csv',
    '09999': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRWwBu0OBPdKNBOgEkHe31yFFYdkrmRRvc-kBspAuIADJH_5MfA0vca9JTrCptZfd48JMJe3ktYMUsX/pub?gid=1033376982&single=true&output=csv',
    '09626': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRWwBu0OBPdKNBOgEkHe31yFFYdkrmRRvc-kBspAuIADJH_5MfA0vca9JTrCptZfd48JMJe3ktYMUsX/pub?gid=1165018627&single=true&output=csv',
    '09961': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRWwBu0OBPdKNBOgEkHe31yFFYdkrmRRvc-kBspAuIADJH_5MfA0vca9JTrCptZfd48JMJe3ktYMUsX/pub?gid=712964135&single=true&output=csv',
    '01398': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRWwBu0OBPdKNBOgEkHe31yFFYdkrmRRvc-kBspAuIADJH_5MfA0vca9JTrCptZfd48JMJe3ktYMUsX/pub?gid=1824392267&single=true&output=csv',
    '00857': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRWwBu0OBPdKNBOgEkHe31yFFYdkrmRRvc-kBspAuIADJH_5MfA0vca9JTrCptZfd48JMJe3ktYMUsX/pub?gid=1633387172&single=true&output=csv',
    '00883': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRWwBu0OBPdKNBOgEkHe31yFFYdkrmRRvc-kBspAuIADJH_5MfA0vca9JTrCptZfd48JMJe3ktYMUsX/pub?gid=1470559862&single=true&output=csv',
    '00981': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRWwBu0OBPdKNBOgEkHe31yFFYdkrmRRvc-kBspAuIADJH_5MfA0vca9JTrCptZfd48JMJe3ktYMUsX/pub?gid=262039719&single=true&output=csv'
  }
};

const $ = s => document.querySelector(s);
const chart = echarts.init($('#chart'));

/* -----------------------------
 * 2) 小工具
 * ----------------------------- */
const toNum = v => {
  const x = Number(v);
  return Number.isFinite(x) ? x : NaN;
};

// 線性插值（避免 RS 斷斷續續）
function linInterp(arr){
  const y = arr.slice();
  let last = null;
  for(let i=0;i<y.length;i++){
    if(Number.isFinite(y[i])) last = i;
    else{
      // 找下一個非 NaN
      let j=i+1; while(j<y.length && !Number.isFinite(y[j])) j++;
      if(last!==null && j<y.length){
        const a = y[last], b = y[j], span = j-last;
        for(let k=1;k<span;k++) y[last+k] = a + (b-a)*k/span;
        i = j;
      }
    }
  }
  return y;
}

// rolling mean
function sma(xs, n){
  const out = new Array(xs.length).fill(NaN);
  let sum = 0, q = [];
  for(let i=0;i<xs.length;i++){
    const v = xs[i];
    if(Number.isFinite(v)){
      q.push(v); sum += v;
      if(q.length>n){ sum -= q.shift(); }
      if(q.length===n) out[i] = sum/n;
    }else{
      q.length = 0; sum = 0; // 遇到缺值就重置，以免污染
    }
  }
  return out;
}

/* -----------------------------
 * 3) 載入 CSV + 合併
 * ----------------------------- */
async function fetchCSV(url){
  const r = await fetch(url, {
    cache:'no-store',
    headers: {
      'Cache-Control': 'no-cache, no-store, must-revalidate',
      'Pragma': 'no-cache',
      'Expires': '0'
    }
  });
  if(!r.ok) throw new Error('HTTP '+r.status);
  return await r.text();
}

function parseCSV(text){
  return new Promise((resolve,reject)=>{
    Papa.parse(text,{
      header:true,
      dynamicTyping:true,
      skipEmptyLines:true,
      complete:res=>resolve(res.data),
      error:reject
    });
  });
}

function showLoading(show) {
  const loading = $('#loadingStatus');
  if (loading) {
    loading.style.display = show ? 'inline' : 'none';
  }
}

async function loadAll(){
  showLoading(true);
  try {
    // 載入 factors 資料
    console.log('Loading factors data...');
    const factorsText = await fetchCSV(DATA_SOURCES.factors);
    const factors = await parseCSV(factorsText);
    console.log('Factors loaded:', factors.length, 'rows');

    // 載入所有股票資料
    const stockData = {};
    const stockCodes = Object.keys(DATA_SOURCES.stocks);
    
    for (const code of stockCodes) {
      try {
        console.log(`Loading stock ${code}...`);
        const stockText = await fetchCSV(DATA_SOURCES.stocks[code]);
        const stockRows = await parseCSV(stockText);
        stockData[code] = stockRows;
        console.log(`Stock ${code} loaded:`, stockRows.length, 'rows');
      } catch (e) {
        console.error(`Error loading stock ${code}:`, e);
        stockData[code] = [];
      }
    }

    return { factors, stockData };
  } catch (e) {
    console.error('Error loading data:', e);
    throw e;
  } finally {
    showLoading(false);
  }
}

/* -----------------------------
 * 4) 主流程：計算 RS / 風險 dots / 背景區塊
 * ----------------------------- */
function buildSeries(mergedData, opt){
  const G = Number($('#thGreen').value);
  const R = Number($('#thRed').value);
  const showBG   = $('#bgChk').checked;
  const showFused= $('#fusedChk').checked;
  const showRS   = $('#rsChk').checked;
  const showDots = $('#dotsChk').checked;

  // 權重版本
  const weightMap = {
    equal: 'Fused_equal',
    macro: 'Fused_macro',
    aggressive_plus: 'Fused_aggressive_plus',
    conservative_plus: 'Fused_conservative_plus'
  };
  const fusedKey = weightMap[$('#wSel').value] || 'Fused_equal';

  // x 軸
  const dates = mergedData.map(r => r.Date);

  // fused
  const fused = mergedData.map(r => toNum(r[fusedKey]));

  // RS 計法（相對強弱）
  const code = $('#stockSel').value;
  const close = mergedData.map(r => toNum(r[code]));
  
  // 60d SMA
  const c60 = sma(close, 60);
  const rsRaw = close.map((c,i)=> Number.isFinite(c)&&Number.isFinite(c60[i]) ? (c/c60[i]-1) : NaN);
  // 平滑（15d）
  const rsSmooth = sma(rsRaw, 15);
  // 線性補內插，避免斷線
  const rs = linInterp(rsSmooth);

  // 將 RS 依強弱分成三段
  const rsStrong = [], rsNeutral = [], rsWeak = [];
  for(let i=0;i<rs.length;i++){
    const v = rs[i];
    if(!Number.isFinite(v)){
      rsStrong.push(NaN); rsNeutral.push(NaN); rsWeak.push(NaN);
    }else if(v > 0){
      rsStrong.push(v); rsNeutral.push(NaN); rsWeak.push(NaN);
    }else if(v < 0){
      rsStrong.push(NaN); rsNeutral.push(NaN); rsWeak.push(v);
    }else{
      rsStrong.push(NaN); rsNeutral.push(v); rsWeak.push(NaN);
    }
  }

  // 背景區塊（Green / Range / Red）
  let areas = [];
  if(showBG){
    let curType = null, start = 0;
    function pushArea(type, s, e){
      if(e<=s) return;
      let color = 'rgba(0,0,0,0)';
      if(type==='G') color = getComputedStyle(document.documentElement).getPropertyValue('--bg-green');
      if(type==='N') color = getComputedStyle(document.documentElement).getPropertyValue('--bg-range');
      if(type==='R') color = getComputedStyle(document.documentElement).getPropertyValue('--bg-red');
      areas.push({
        name: (type==='G'?'Green':type==='R'?'Red':'Range'),
        itemStyle:{color},
        xAxis:[dates[s], dates[e-1]]
      });
    }
    for(let i=0;i<dates.length;i++){
      const f = fused[i];
      const t = Number.isFinite(f) ? (f>=G?'G':(f<=R?'R':'N')) : curType;
      if(curType==null){ curType=t; start=i; continue; }
      if(t!==curType){ pushArea(curType,start,i); curType=t; start=i; }
      if(i===dates.length-1) pushArea(curType,start,i+1);
    }
  }

  // 風險 dots
  const amber = [], red = [];
  if(showDots){
    for(let i=0;i<dates.length;i++){
      const v = rs[i];
      if(!Number.isFinite(v)) continue;
      if(v >= 0) amber.push([dates[i], v + 0.03]); 
      else       red.push([dates[i], v - 0.03]);   
    }
  }

  // 狀態 pill
  const lastF = fused.at(-1);
  const state = Number.isFinite(lastF) ? (lastF>=G?'green':(lastF<=R?'red':'range')) : 'range';
  const badge = $('#stateBadge');
  badge.className = 'badge '+state;
  badge.textContent = state==='green'?'Green':state==='red'?'Red':'Range';

  // ECharts series 組裝
  const series = [];

  // 背景分區
  if(showBG && areas.length){
    series.push({
      type:'line',
      name:'BG',
      data: fused.map(_=>NaN),
      markArea:{
        silent:true,
        itemStyle:{opacity:1},
        data: areas.map(a=>[{xAxis:a.xAxis[0],itemStyle:{color:a.itemStyle.color}},{xAxis:a.xAxis[1]}])
      },
      lineStyle:{opacity:0}, symbol:'none', z:0, zlevel:0
    });
  }

  if(showFused){
    series.push({
      type:'line', name:'Fused',
      data: fused, symbol:'none',
      lineStyle:{width:2,color:getComputedStyle(document.documentElement).getPropertyValue('--blue')},
      z:3
    });
  }

  if(showRS){
    const cGreen = getComputedStyle(document.documentElement).getPropertyValue('--green').trim();
    const cGray  = getComputedStyle(document.documentElement).getPropertyValue('--muted').trim();
    const cRed   = getComputedStyle(document.documentElement).getPropertyValue('--red').trim();
    series.push({
      type:'line', name:'RS',
      data: rsStrong, symbol:'none',
      lineStyle:{width:2,color:cGreen,type:'dashed'},
      z:3
    });
    series.push({
      type:'line', name:'RS',
      data: rsNeutral, symbol:'none',
      lineStyle:{width:2,color:cGray,type:'dashed'},
      z:3
    });
    series.push({
      type:'line', name:'RS',
      data: rsWeak, symbol:'none',
      lineStyle:{width:2,color:cRed,type:'dashed'},
      z:3
    });
  }

  if(showDots && amber.length){
    series.push({
      type:'scatter', name:'Amber',
      data: amber, symbolSize:6,
      itemStyle:{color:getComputedStyle(document.documentElement).getPropertyValue('--amber').trim()},
      z:4
    });
  }
  if(showDots && red.length){
    series.push({
      type:'scatter', name:'Red',
      data: red, symbolSize:6,
      itemStyle:{color:getComputedStyle(document.documentElement).getPropertyValue('--red').trim()},
      z:4
    });
  }

  return {series, dates};
}

/* -----------------------------
 * 5) 畫圖 + 交互
 * ----------------------------- */
let RAW_DATA = {factors:null, stockData:null};
let mergedData = [];     // 合併後的資料
let currentRange = '6M';

function mergeData(factors, stockData){
  if(!factors || !factors.length) return [];
  
  // 建立日期到股票資料的映射
  const stockMaps = {};
  Object.keys(stockData).forEach(code => {
    stockMaps[code] = new Map();
    stockData[code].forEach(row => {
      if(row.Date && row.Close !== undefined) {
        stockMaps[code].set(row.Date, toNum(row.Close));
      }
    });
  });

  // 合併資料
  return factors.map(factorRow => {
    const merged = { ...factorRow };
    
    // 添加每隻股票的收盤價
    Object.keys(stockMaps).forEach(code => {
      merged[code] = stockMaps[code].get(factorRow.Date) || NaN;
    });
    
    return merged;
  }).filter(row => row.Date); // 確保有日期
}

function applyRange(dates){
  const n = dates.length;
  let keep = n;
  if(currentRange==='1Y') keep = Math.min(n, 260);
  if(currentRange==='6M') keep = Math.min(n, 130);
  if(currentRange==='3M') keep = Math.min(n, 65);
  if(currentRange==='1M') keep = Math.min(n, 22);
  return Math.max(0, n-keep);
}

function render(){
  if(!mergedData.length) {
    console.log('No merged data available for rendering');
    return;
  }
  
  try {
    const {series, dates} = buildSeries(mergedData);
    const startIdx = applyRange(dates);

    chart.setOption({
      animation:false,
      tooltip:{trigger:'axis'},
      dataZoom:[{type:'inside',startValue:startIdx,endValue:dates.length-1},{type:'slider'}],
      xAxis:{type:'category',data:dates,axisLabel:{color:'#6b7280'}},
      yAxis:{type:'value',axisLabel:{color:'#6b7280'}},
      series
    }, true);
  } catch (e) {
    console.error('Error rendering chart:', e);
  }
}

function computeRS(data, code){
  const close = data.map(r => toNum(r[code]));
  const c60 = sma(close, 60);
  const rsRaw = close.map((c,i)=> Number.isFinite(c) && Number.isFinite(c60[i]) ? (c/c60[i]-1) : NaN);
  const rsSmooth = sma(rsRaw, 15);
  const rs = linInterp(rsSmooth);
  return rs[rs.length-1];
}

function renderRSStatus(){
  const bar = $('#rsBar');
  if(!bar) return;
  bar.innerHTML = '';
  if(!mergedData.length) return;
  
  const codes = Array.from($('#stockSel').options).map(o=>o.value);
  codes.forEach(code=>{
    const v = computeRS(mergedData, code);
    const div = document.createElement('div');
    div.className = 'rs-item';
    if(Number.isFinite(v)){
      const cls = v>0 ? 'green' : (v<0 ? 'red' : 'range');
      div.classList.add(cls);
      div.innerHTML = `${code} <span class="val">${(v*100).toFixed(1)}%</span>`;
    }else{
      div.classList.add('range');
      div.textContent = `${code} N/A`;
    }
    bar.appendChild(div);
  });
}

async function main(){
  try {
    console.log('Starting data load...');
    RAW_DATA = await loadAll();
    console.log('Raw data loaded:', {
      factors: RAW_DATA.factors?.length || 0,
      stockData: Object.keys(RAW_DATA.stockData || {}).length
    });
    
    mergedData = mergeData(RAW_DATA.factors, RAW_DATA.stockData);
    console.log('Merged data:', mergedData.length, 'rows');
    
    if (mergedData.length > 0) {
      console.log('Sample merged row:', mergedData[0]);
      render();
      renderRSStatus();
    } else {
      console.warn('No merged data available');
    }
  } catch (e) {
    console.error('Error in main():', e);
    const badge = $('#stateBadge');
    badge.className = 'badge red';
    badge.textContent = 'Error';
  }
}

/* -----------------------------
 * 6) 事件
 * ----------------------------- */
async function fetchFutu(){
  const code = 'HK.' + $('#stockSel').value;
  try{
    const r = await fetch(`/api/snapshot?code=${code}`);
    if(!r.ok) throw new Error('HTTP '+r.status);
    const data = await r.json();
    console.log('Futu snapshot', data);
  }catch(e){
    console.error('Futu API error', e);
    alert('無法取得 Futu 資料');
  }
}

$('#btnRefresh').addEventListener('click', main);
$('#btnReset').addEventListener('click', ()=>{
  $('#thGreen').value = 0.50;
  $('#thRed').value   = -0.5;
  $('#bgChk').checked = true;
  $('#fusedChk').checked = true;
  $('#rsChk').checked  = true;
  $('#dotsChk').checked= true;
  $('#wSel').value = 'equal';
  currentRange = '6M';
  document.querySelectorAll('#rangeBtns .btn').forEach(b=>b.classList.toggle('active', b.dataset.range==='6M'));
  render();
  renderRSStatus();
});

// 監聽控制項變化
['#thGreen','#thRed','#bgChk','#fusedChk','#rsChk','#dotsChk','#wSel','#stockSel']
  .forEach(sel => {
    const el = $(sel);
    if (el) {
      el.addEventListener('change', () => {
        render();
        renderRSStatus();
      });
    }
  });

// 時間範圍按鈕
document.querySelectorAll('#rangeBtns .btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('#rangeBtns .btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    currentRange = btn.dataset.range;
    render();
  });
});

$('#btnFutu').addEventListener('click', fetchFutu);

// 自動更新（每 5 分鐘）
setInterval(() => {
  console.log('Auto refresh triggered');
  main();
}, 5 * 60 * 1000);

// 初始化
main();
    