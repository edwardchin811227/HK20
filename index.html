<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>HK20 • Risk ON/OFF + RS</title>

<!-- ECharts -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>

<style>
:root{
  --bg:#fff; --text:#111827; --muted:#6b7280; --border:#e5e7eb; --chip:#f3f4f6;
  --green:#10b981; --amber:#f59e0b; --red:#ef4444; --blue:#2563eb;
  --bg-green: rgba(16,185,129,.10);
  --bg-range: rgba(107,114,128,.10);
  --bg-red: rgba(239,68,68,.10);
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial}
.wrap{max-width:1280px;margin:0 auto;padding:16px}
.toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:10px}
.pill{padding:6px 12px;border-radius:999px;border:1px solid var(--border);background:#fff;display:inline-flex;gap:8px;align-items:center}
.pill input, .pill select{padding:6px 10px;border:1px solid var(--border);border-radius:8px;min-width:90px}
.pill .btn{padding:6px 10px;border:1px solid var(--border);border-radius:8px;background:#fff;cursor:pointer}
.pill .btn.active{background:#111827;color:#fff;border-color:#111827}
.badge{font-weight:700;border-radius:999px;padding:6px 12px}
.badge.green{color:#065f46;background:#d1fae5;border:1px solid #a7f3d0}
.badge.range{color:#334155;background:#e2e8f0;border:1px solid #cbd5e1}
.badge.red{color:#7f1d1d;background:#fee2e2;border:1px solid #fecaca}
.switch{display:flex;gap:8px;align-items:center;border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:#fff}
.chk{display:flex;gap:6px;align-items:center}
.legend{display:flex;gap:16px;align-items:center;color:var(--muted)}
.dot{width:8px;height:8px;border-radius:999px;display:inline-block;margin-right:6px}
.cGreen{background:var(--green)}
.cAmber{background:var(--amber)}
.cRed{background:var(--red)}
.cBlue{background:var(--blue)}
.cGray{background:var(--muted)}
.rs-bar{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0}
.rs-item{display:flex;align-items:center;gap:4px;padding:4px 8px;border:1px solid var(--border);border-radius:4px;background:#fff;font-size:12px}
.rs-item.green{color:var(--green);background:var(--bg-green)}
.rs-item.red{color:var(--red);background:var(--bg-red)}
.rs-item.range{color:var(--muted);background:var(--bg-range)}
.rs-item .val{font-weight:700}
#chart{height:560px}
small{color:var(--muted)}
hr{border:none;border-top:1px solid var(--border);margin:8px 0}
.loading{color:var(--amber);font-weight:bold}
.error{color:var(--red);font-weight:bold}
.status-msg{padding:10px;margin:10px 0;border-radius:8px;background:#fef3c7;border:1px solid #fcd34d;color:#92400e}
@media (max-width:720px){ #chart{height:480px} }
</style>
</head>
<body>
<div class="wrap">

  <!-- 狀態 -->
  <div class="toolbar">
    <span id="stateBadge" class="badge range">Range</span>
    <span id="loadingStatus" class="loading" style="display:none">載入中...</span>
    <span id="errorStatus" class="error" style="display:none"></span>

    <div class="pill" id="rangeBtns">
      <button class="btn" data-range="1Y">1Y</button>
      <button class="btn active" data-range="6M">6M</button>
      <button class="btn" data-range="3M">3M</button>
      <button class="btn" data-range="1M">1M</button>
    </div>

    <div class="pill">
      <label>股票：</label>
      <select id="stockSel">
        <option>00700</option><option>09988</option><option>03690</option><option>01024</option><option>01810</option>
        <option>09618</option><option>00388</option><option>02318</option><option>03988</option><option>00939</option>
        <option>09888</option><option>00005</option><option>01211</option><option>09999</option><option>09626</option>
        <option>09961</option><option>01398</option><option>00857</option><option>00883</option><option>00981</option>
      </select>
    </div>

    <div class="pill">
      <label>Fused 權重：</label>
      <select id="wSel">
        <option value="equal">等權（Fused_equal）</option>
        <option value="macro">宏觀（Fused_macro）</option>
        <option value="aggressive_plus">Aggressive+（Fused_aggressive_plus）</option>
        <option value="conservative_plus">Conservative+（Fused_conservative_plus）</option>
      </select>
    </div>

    <div class="pill">
      <button id="btnRefresh" class="btn">更新</button>
      <button id="btnReset" class="btn">重設</button>
    </div>
  </div>

  <!-- 門檻 -->
  <div class="toolbar">
    <div class="pill">
      <label>Green ≥</label>
      <input id="thGreen" type="number" step="0.05" value="0.50">
      <label style="margin-left:8px">Red ≤</label>
      <input id="thRed" type="number" step="0.05" value="-0.5">
      <small>（即時調整門檻，背景同步改變）</small>
    </div>

    <div class="switch">
      <label class="chk"><input type="checkbox" id="bgChk" checked> 背景著色（Green/Range/Red）</label>
      <label class="chk"><input type="checkbox" id="fusedChk" checked> Fused</label>
      <label class="chk"><input type="checkbox" id="rsChk" checked> RS（相對強弱）</label>
      <label class="chk"><input type="checkbox" id="dotsChk" checked> 風險 Dots（<span style="color:var(--amber)">Amber 上</span> / <span style="color:var(--red)">Red 下</span>）</label>
    </div>
  </div>

  <div id="statusMsg" class="status-msg" style="display:none"></div>
  <div id="rsBar" class="rs-bar"></div>

  <div class="legend">
    <span><i class="dot cBlue"></i>Fused</span>
    <span><i class="dot cGray"></i>RS</span>
    <span><i class="dot cAmber"></i>Amber</span>
    <span><i class="dot cRed"></i>Red</span>
  </div>

  <div id="chart"></div>
  <small>資料來源：Google Apps Script API | 最後更新：<span id="lastUpdate">-</span></small>
</div>

<script>
// Google Apps Script Web App URL
// 部署後，將這個 URL 替換為您的 Web App URL
const GAS_API_URL = 'https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec';

const $ = s => document.querySelector(s);
const chart = echarts.init($('#chart'));

/* -----------------------------
 * 1) 小工具
 * ----------------------------- */
const toNum = v => {
  const x = Number(v);
  return Number.isFinite(x) ? x : NaN;
};

// 線性插值（避免 RS 斷斷續續）
function linInterp(arr){
  const y = arr.slice();
  let last = null;
  for(let i=0;i<y.length;i++){
    if(Number.isFinite(y[i])) last = i;
    else{
      let j=i+1; while(j<y.length && !Number.isFinite(y[j])) j++;
      if(last!==null && j<y.length){
        const a = y[last], b = y[j], span = j-last;
        for(let k=1;k<span;k++) y[last+k] = a + (b-a)*k/span;
        i = j;
      }
    }
  }
  return y;
}

// rolling mean
function sma(xs, n){
  const out = new Array(xs.length).fill(NaN);
  let sum = 0, q = [];
  for(let i=0;i<xs.length;i++){
    const v = xs[i];
    if(Number.isFinite(v)){
      q.push(v); sum += v;
      if(q.length>n){ sum -= q.shift(); }
      if(q.length===n) out[i] = sum/n;
    }else{
      q.length = 0; sum = 0;
    }
  }
  return out;
}

/* -----------------------------
 * 2) 載入資料
 * ----------------------------- */
function showLoading(show) {
  const loading = $('#loadingStatus');
  if (loading) {
    loading.style.display = show ? 'inline' : 'none';
  }
}

function showError(msg) {
  const error = $('#errorStatus');
  const statusMsg = $('#statusMsg');
  if (error) {
    error.textContent = msg || '';
    error.style.display = msg ? 'inline' : 'none';
  }
  if (statusMsg && msg) {
    statusMsg.innerHTML = `<strong>錯誤：</strong>${msg}`;
    statusMsg.style.display = 'block';
  } else if (statusMsg) {
    statusMsg.style.display = 'none';
  }
}

async function loadFromGAS() {
  showLoading(true);
  showError('');
  
  try {
    // 如果在 Google Apps Script 環境中
    if (typeof google !== 'undefined' && google.script && google.script.run) {
      // 使用 google.script.run 直接調用後端函數
      return new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)
          .handleDataRequest({ parameter: { action: 'getData', type: 'all' } });
      });
    } else {
      // 使用 fetch 調用 Web App API
      const response = await fetch(`${GAS_API_URL}?action=getData&type=all`);
      if (!response.ok) throw new Error('HTTP ' + response.status);
      return await response.json();
    }
  } catch (e) {
    console.error('Error loading data:', e);
    showError(`載入資料失敗: ${e.message}`);
    throw e;
  } finally {
    showLoading(false);
  }
}

/* -----------------------------
 * 3) 主流程
 * ----------------------------- */
let mergedData = [];
let currentRange = '6M';

function mergeData(factors, stockData) {
  if (!factors || !factors.length) return [];
  
  const stockMaps = {};
  Object.keys(stockData).forEach(code => {
    stockMaps[code] = new Map();
    stockData[code].forEach(row => {
      if (row.Date && row.Close !== undefined) {
        stockMaps[code].set(row.Date, toNum(row.Close));
      }
    });
  });

  return factors.map(factorRow => {
    const merged = { ...factorRow };
    Object.keys(stockMaps).forEach(code => {
      merged[code] = stockMaps[code].get(factorRow.Date) || NaN;
    });
    return merged;
  }).filter(row => row.Date);
}

function buildSeries(mergedData) {
  const G = Number($('#thGreen').value);
  const R = Number($('#thRed').value);
  const showBG = $('#bgChk').checked;
  const showFused = $('#fusedChk').checked;
  const showRS = $('#rsChk').checked;
  const showDots = $('#dotsChk').checked;

  const weightMap = {
    equal: 'Fused_equal',
    macro: 'Fused_macro',
    aggressive_plus: 'Fused_aggressive_plus',
    conservative_plus: 'Fused_conservative_plus'
  };
  const fusedKey = weightMap[$('#wSel').value] || 'Fused_equal';

  const dates = mergedData.map(r => r.Date);
  const fused = mergedData.map(r => toNum(r[fusedKey]));

  const code = $('#stockSel').value;
  const close = mergedData.map(r => toNum(r[code]));
  
  const c60 = sma(close, 60);
  const rsRaw = close.map((c,i)=> Number.isFinite(c)&&Number.isFinite(c60[i]) ? (c/c60[i]-1) : NaN);
  const rsSmooth = sma(rsRaw, 15);
  const rs = linInterp(rsSmooth);

  // 將 RS 分成三段
  const rsStrong = [], rsNeutral = [], rsWeak = [];
  for(let i=0;i<rs.length;i++){
    const v = rs[i];
    if(!Number.isFinite(v)){
      rsStrong.push(NaN); rsNeutral.push(NaN); rsWeak.push(NaN);
    }else if(v > 0){
      rsStrong.push(v); rsNeutral.push(NaN); rsWeak.push(NaN);
    }else if(v < 0){
      rsStrong.push(NaN); rsNeutral.push(NaN); rsWeak.push(v);
    }else{
      rsStrong.push(NaN); rsNeutral.push(v); rsWeak.push(NaN);
    }
  }

  // 背景區塊
  let areas = [];
  if(showBG){
    let curType = null, start = 0;
    function pushArea(type, s, e){
      if(e<=s) return;
      let color = 'rgba(0,0,0,0)';
      if(type==='G') color = 'rgba(16,185,129,.10)';
      if(type==='N') color = 'rgba(107,114,128,.10)';
      if(type==='R') color = 'rgba(239,68,68,.10)';
      areas.push({
        name: (type==='G'?'Green':type==='R'?'Red':'Range'),
        itemStyle:{color},
        xAxis:[dates[s], dates[e-1]]
      });
    }
    for(let i=0;i<dates.length;i++){
      const f = fused[i];
      const t = Number.isFinite(f) ? (f>=G?'G':(f<=R?'R':'N')) : curType;
      if(curType==null){ curType=t; start=i; continue; }
      if(t!==curType){ pushArea(curType,start,i); curType=t; start=i; }
      if(i===dates.length-1) pushArea(curType,start,i+1);
    }
  }

  // 風險 dots
  const amber = [], red = [];
  if(showDots){
    for(let i=0;i<dates.length;i++){
      const v = rs[i];
      if(!Number.isFinite(v)) continue;
      if(v >= 0) amber.push([dates[i], v + 0.03]); 
      else red.push([dates[i], v - 0.03]);   
    }
  }

  // 更新狀態 badge
  const lastF = fused.at(-1);
  const state = Number.isFinite(lastF) ? (lastF>=G?'green':(lastF<=R?'red':'range')) : 'range';
  const badge = $('#stateBadge');
  badge.className = 'badge '+state;
  badge.textContent = state==='green'?'Green':state==='red'?'Red':'Range';

  // 組裝 series
  const series = [];

  if(showBG && areas.length){
    series.push({
      type:'line',
      name:'BG',
      data: fused.map(_=>NaN),
      markArea:{
        silent:true,
        itemStyle:{opacity:1},
        data: areas.map(a=>[{xAxis:a.xAxis[0],itemStyle:{color:a.itemStyle.color}},{xAxis:a.xAxis[1]}])
      },
      lineStyle:{opacity:0}, symbol:'none', z:0, zlevel:0
    });
  }

  if(showFused){
    series.push({
      type:'line', name:'Fused',
      data: fused, symbol:'none',
      lineStyle:{width:2,color:'#2563eb'},
      z:3
    });
  }

  if(showRS){
    series.push({
      type:'line', name:'RS Strong',
      data: rsStrong, symbol:'none',
      lineStyle:{width:2,color:'#10b981',type:'dashed'},
      z:3
    });
    series.push({
      type:'line', name:'RS Neutral',
      data: rsNeutral, symbol:'none',
      lineStyle:{width:2,color:'#6b7280',type:'dashed'},
      z:3
    });
    series.push({
      type:'line', name:'RS Weak',
      data: rsWeak, symbol:'none',
      lineStyle:{width:2,color:'#ef4444',type:'dashed'},
      z:3
    });
  }

  if(showDots && amber.length){
    series.push({
      type:'scatter', name:'Amber',
      data: amber, symbolSize:6,
      itemStyle:{color:'#f59e0b'},
      z:4
    });
  }
  
  if(showDots && red.length){
    series.push({
      type:'scatter', name:'Red',
      data: red, symbolSize:6,
      itemStyle:{color:'#ef4444'},
      z:4
    });
  }

  return {series, dates};
}

function applyRange(dates){
  const n = dates.length;
  let keep = n;
  if(currentRange==='1Y') keep = Math.min(n, 260);
  if(currentRange==='6M') keep = Math.min(n, 130);
  if(currentRange==='3M') keep = Math.min(n, 65);
  if(currentRange==='1M') keep = Math.min(n, 22);
  return Math.max(0, n-keep);
}

function render(){
  if(!mergedData.length) {
    console.log('No merged data available');
    return;
  }
  
  try {
    const {series, dates} = buildSeries(mergedData);
    const startIdx = applyRange(dates);

    chart.setOption({
      animation:false,
      tooltip:{trigger:'axis'},
      dataZoom:[{type:'inside',startValue:startIdx,endValue:dates.length-1},{type:'slider'}],
      xAxis:{type:'category',data:dates,axisLabel:{color:'#6b7280'}},
      yAxis:{type:'value',axisLabel:{color:'#6b7280'}},
      series
    }, true);
  } catch (e) {
    console.error('Error rendering chart:', e);
    showError(`圖表渲染失敗: ${e.message}`);
  }
}

function computeRS(data, code){
  const close = data.map(r => toNum(r[code]));
  const c60 = sma(close, 60);
  const rsRaw = close.map((c,i)=> Number.isFinite(c) && Number.isFinite(c60[i]) ? (c/c60[i]-1) : NaN);
  const rsSmooth = sma(rsRaw, 15);
  const rs = linInterp(rsSmooth);
  return rs[rs.length-1];
}

function renderRSStatus(){
  const bar = $('#rsBar');
  if(!bar) return;
  bar.innerHTML = '';
  if(!mergedData.length) return;
  
  const codes = Array.from($('#stockSel').options).map(o=>o.value);
  codes.forEach(code=>{
    const v = computeRS(mergedData, code);
    const div = document.createElement('div');
    div.className = 'rs-item';
    if(Number.isFinite(v)){
      const cls = v>0 ? 'green' : (v<0 ? 'red' : 'range');
      div.classList.add(cls);
      div.innerHTML = `${code} <span class="val">${(v*100).toFixed(1)}%</span>`;
    }else{
      div.classList.add('range');
      div.textContent = `${code} N/A`;
    }
    bar.appendChild(div);
  });
}

async function main(){
  try {
    console.log('Starting data load from GAS...');
    const data = await loadFromGAS();
    
    if (data.error) {
      throw new Error(data.message || data.error);
    }
    
    console.log('Data loaded:', {
      factors: data.factors?.length || 0,
      stocks: Object.keys(data.stocks || {}).length,
      lastUpdate: data.lastUpdate
    });
    
    mergedData = mergeData(data.factors, data.stocks);
    console.log('Merged data:', mergedData.length, 'rows');
    
    if (mergedData.length > 0) {
      render();
      renderRSStatus();
      $('#lastUpdate').textContent = data.lastUpdate || new Date().toLocaleString('zh-HK');
      showError('');
    } else {
      showError('無合併資料可用');
    }
  } catch (e) {
    console.error('Error in main():', e);
    const badge = $('#stateBadge');
    badge.className = 'badge red';
    badge.textContent = 'Error';
    showError(`載入失敗: ${e.message}`);
  }
}

/* -----------------------------
 * 4) 事件處理
 * ----------------------------- */
$('#btnRefresh').addEventListener('click', main);
$('#btnReset').addEventListener('click', ()=>{
  $('#thGreen').value = 0.50;
  $('#thRed').value = -0.5;
  $('#bgChk').checked = true;
  $('#fusedChk').checked = true;
  $('#rsChk').checked = true;
  $('#dotsChk').checked = true;
  $('#wSel').value = 'equal';
  currentRange = '6M';
  document.querySelectorAll('#rangeBtns .btn').forEach(b=>b.classList.toggle('active', b.dataset.range==='6M'));
  render();
  renderRSStatus();
});

// 監聽控制項變化
['#thGreen','#thRed','#bgChk','#fusedChk','#rsChk','#dotsChk','#wSel','#stockSel']
  .forEach(sel => {
    const el = $(sel);
    if (el) {
      el.addEventListener('change', () => {
        render();
        renderRSStatus();
      });
    }
  });

// 時間範圍按鈕
document.querySelectorAll('#rangeBtns .btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('#rangeBtns .btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    currentRange = btn.dataset.range;
    render();
  });
});

// 自動更新（每 5 分鐘檢查）
setInterval(() => {
  const now = new Date();
  const hours = now.getHours();
  const minutes = now.getMinutes();
  
  // 在 16:30 - 16:35 之間自動更新
  if (hours === 16 && minutes >= 30 && minutes <= 35) {
    console.log('Auto refresh at market close');
    main();
  }
}, 5 * 60 * 1000);

// 初始化
window.addEventListener('DOMContentLoaded', main);
</script>
</body>
</html>