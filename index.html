<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>HK20 × 5因子（單一工作表）</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<style>
  :root{
    --bg:#0b0f14; --panel:#111923; --muted:#9fb0c1; --line:#1f2833; --chip:#0f1620;
    --accent:#1b88f5; --green:#4ce08a; --green-bg:#153d2b; --red:#ff6b81; --red-bg:#3a1a22;
  }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:#e6edf3;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC",sans-serif}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--line)}
  .title{display:flex;gap:12px;align-items:center}
  .badge{padding:2px 10px;border-radius:999px;border:1px solid var(--line);font-size:12px;background:#19202a;color:var(--muted)}
  .badge.green{background:var(--green-bg);color:var(--green);border-color:#245a3e}
  .badge.red{background:var(--red-bg);color:var(--red);border-color:#562431}
  .toolbar{display:flex;gap:12px;flex-wrap:wrap;align-items:center;padding:12px 16px}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:10px 12px}
  .chip{background:var(--chip);border:1px solid var(--line);color:#d7e3ef;border-radius:10px;padding:6px 10px;cursor:pointer}
  .chip:hover{border-color:#2b3a4a}
  label{font-size:12px;margin-right:6px} input[type="number"]{width:64px;background:var(--bg);border:1px solid #2b3a4a;border-radius:6px;color:#e6edf3;padding:4px 6px}
  input[type="checkbox"]{transform:translateY(1px)}
  #chart{height:560px;width:100%} .hint{color:var(--muted);font-size:12px}
  .sliders{display:grid;grid-template-columns:64px 1fr;gap:6px 12px;align-items:center}
  input[type="range"]{width:100%}
  .error{color:#ffb4c2;font-size:12px}
</style>
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
<header>
  <div class="title">
    <strong>HK20 × 5因子（單一工作表）</strong>
    <span id="statusBadge" class="badge">Status: Range</span>
    <span class="badge">資料源：GitHub raw CSV</span>
  </div>
  <div id="err" class="error"></div>
</header>

<section class="toolbar">
  <div class="panel">
    <label>閾值：</label>
    <label>Green ≥ <input id="thGreen" type="number" step="0.1"></label>
    <label>Red ≤ <input id="thRed" type="number" step="0.1"></label>
    <button id="btnReset" class="chip">重設</button>
  </div>
  <div class="panel">
    <label><input id="chkZones" type="checkbox"> 顯示分區</label>
    <label><input id="chkFused" type="checkbox" checked> 顯示 Fused</label>
    <button class="chip q" data-d="365">1Y</button>
    <button class="chip q" data-d="180">6M</button>
    <button class="chip q" data-d="90">3M</button>
    <button class="chip q" data-d="30">1M</button>
    <button class="chip q" data-d="all">全部</button>
  </div>
</section>

<section class="toolbar">
  <div class="panel sliders" style="min-width:420px">
    <label>Start</label><input id="sStart" type="range" min="0" max="100" value="0">
    <label>Mid</label>  <input id="sMid"   type="range" min="0" max="100" value="50">
    <label>End</label>  <input id="sEnd"   type="range" min="0" max="100" value="100">
    <div class="hint" style="grid-column:1 / -1">視窗：預設 1M=30 天；不足 30 → 用 n−1；最小視窗=5 天。Mid 只平移，Start/End 會改變視窗長度（自動夾入界限）。</div>
  </div>
</section>

<div id="chart"></div>

<script>
/* ========= 1) 多源輪詢（先 jsDelivr，後 raw） =========
   註：PapaParse 可直接下載遠端 CSV（download:true），這是官方支援用法。:contentReference[oaicite:1]{index=1}
*/
const SOURCES = [
  // jsDelivr 會把 GitHub 當 CDN，用於避開 raw 的偶發 CORS/節流
  'https://cdn.jsdelivr.net/gh/edwardchin811227/HK20@main/data/factors.csv',
  // 備援：raw（通常也可跨域，但有時會受策略/環境影響） :contentReference[oaicite:2]{index=2}
  'https://raw.githubusercontent.com/edwardchin811227/HK20/main/data/factors.csv'
];

const STORE_KEY = 'HK20_UI_V1';
const defaults = { thGreen:0.5, thRed:-0.5, showZones:true, showFused:true };
const state = loadState();
const chart = echarts.init(document.getElementById('chart'));  // 官方：init 容器返回實例 :contentReference[oaicite:3]{index=3}

initUI();
loadDataWithFallback();

/* ========= 2) 下載 + 解析 ========= */
async function loadDataWithFallback(){
  document.getElementById('err').textContent = '';
  let lastErr = null;
  for (const url of SOURCES){
    try{
      const rows = await parseCsv(url);
      if (!rows.length) throw new Error('CSV 為空或欄位不符');
      const dates = rows.map(r=>r.Date);
      const fused = rows.map(r=>Number(r.Fused_macro));
      if (!fused.some(v=>Number.isFinite(v))) throw new Error('Fused_macro 全部不是數字');
      // 初始視窗：近 30 天；若不足 30 則 n-1；最小 5
      const n = dates.length, win = Math.max(5, Math.min(30, n-1));
      setWindow(n-win, n-1, n);
      render(dates, fused);
      return;  // 成功就結束
    }catch(e){
      lastErr = e;
      console.warn('[CSV fail]', url, e);
    }
  }
  document.getElementById('err').textContent = '讀取資料失敗：' + (lastErr? lastErr.message : '未知錯誤');
}

function parseCsv(url){
  return new Promise((resolve, reject)=>{
    Papa.parse(url, {
      download: true, header: true, dynamicTyping: true, skipEmptyLines: true,
      complete: (res)=>{
        try{
          const rows = res.data
            .filter(r => r.Date && r.Fused_macro !== undefined)
            .map(r => ({Date: r.Date, Fused_macro: Number(r.Fused_macro)}));
          resolve(rows);
        }catch(err){ reject(err); }
      },
      error: (err)=> reject(err)
    });
  });
}

/* ========= 3) 視覺（hsi-dashboard 風格） ========= */
function render(dates, fused){
  const {thGreen, thRed, showZones, showFused} = state;

  // 背景分區（ECharts markArea） :contentReference[oaicite:4]{index=4}
  const zones = showZones ? buildZones(dates, fused, thGreen, thRed) : [];

  // dot：Amber = 上穿 +0.3；Red = 下穿 thRed
  const AMBER = 0.3, amberDots=[], redDots=[];
  for (let i=1;i<fused.length;i++){
    if (fused[i-1] < AMBER && fused[i] >= AMBER) amberDots.push([dates[i], fused[i]]);
    if (fused[i-1] > thRed && fused[i] <= thRed) redDots.push([dates[i], fused[i]]);
  }

  // 狀態徽章（以最新 Fused）
  setBadge(fused[fused.length-1], thGreen, thRed);

  const series=[];
  if (showFused){
    series.push({
      name:'Fused', type:'line', data: dates.map((d,i)=>[d, fused[i]]),
      showSymbol:false, smooth:0.15, lineStyle:{width:2}
    });
  }
  series.push(
    { name:'Amber', type:'scatter', data:amberDots, symbolSize:8, itemStyle:{color:'#f5a524'} },
    { name:'Risk',  type:'scatter', data:redDots,   symbolSize:8, itemStyle:{color:'#ff6b81'} }
  );

  const opt = {
    backgroundColor:'#0b0f14',
    tooltip:{trigger:'axis'},
    legend:{show:false},
    grid:{left:40,right:20,top:8,bottom:60},
    xAxis:{type:'category', data:dates, axisLine:{lineStyle:{color:'#2b3a4a'}}},
    yAxis:{type:'value', min:-1, max:1, axisLine:{lineStyle:{color:'#2b3a4a'}},
           splitLine:{lineStyle:{color:'#1f2833'}}},
    dataZoom:[ // 官方：dataZoom slider/inside 控制視窗 :contentReference[oaicite:5]{index=5}
      {type:'inside', xAxisIndex:0},
      {type:'slider', xAxisIndex:0, bottom:20, height:18}
    ],
    series
  };
  if (showZones && series.length>0){
    series[0].markArea = {itemStyle:{opacity:0.2}, data: zones};
  }
  chart.setOption(opt, true);
  syncSlidersWithChart(dates.length);
  chart.on('datazoom', ()=> syncSlidersWithChart(dates.length));
}

function buildZones(dates, fused, g, r){
  const out=[]; let cur=null;
  const push=(j)=>{ if(!cur) return; out.push([{xAxis:dates[cur.start]},{xAxis:dates[j],itemStyle:{color:cur.color}}]); cur=null; };
  for (let i=0;i<fused.length;i++){
    const v=fused[i], tag=(v>=g)?'G':(v<=r?'R':'N');
    const color = tag==='G'? '#4ce08a' : tag==='R'? '#ff6b81' : null;
    if (!color){ if(cur) push(i-1); continue; }
    if (!cur) cur={color, start:i};
    else if (color!==cur.color){ push(i-1); cur={color, start:i}; }
  }
  if (cur) push(fused.length-1);
  return out;
}

/* ========= 4) UI / 狀態保存 ========= */
function initUI(){
  const $=id=>document.getElementById(id);
  $('#thGreen').value=state.thGreen; $('#thRed').value=state.thRed;
  $('#chkZones').checked=state.showZones; $('#chkFused').checked=state.showFused;
  $('#thGreen').oninput=e=>{ state.thGreen=+e.target.value; saveState(); loadDataWithFallback(); };
  $('#thRed').oninput  =e=>{ state.thRed  =+e.target.value; saveState(); loadDataWithFallback(); };
  $('#chkZones').onchange=e=>{ state.showZones=e.target.checked; saveState(); loadDataWithFallback(); };
  $('#chkFused').onchange=e=>{ state.showFused=e.target.checked; saveState(); loadDataWithFallback(); };
  document.querySelectorAll('.q').forEach(b=> b.onclick=()=> quickWindow(b.dataset.d));
  document.getElementById('btnReset').onclick=()=>{ Object.assign(state, defaults); saveState(); location.reload(); };
}
function loadState(){ try{ return {...defaults, ...(JSON.parse(localStorage.getItem(STORE_KEY)||'{}'))}; }catch(_){ return {...defaults}; } }
function saveState(){ localStorage.setItem(STORE_KEY, JSON.stringify(state)); }
function setBadge(v,g,r){
  const el=document.getElementById('statusBadge');
  el.className='badge'; el.textContent='Status: Range';
  if (v>=g){ el.className='badge green'; el.textContent='Status: Green'; }
  else if (v<=r){ el.className='badge red'; el.textContent='Status: Red'; }
}

/* ========= 5) 三滑桿 × dataZoom ========= */
function setWindow(sIdx,eIdx,n){
  const sPct = 100*sIdx/(n-1), ePct = 100*eIdx/(n-1);
  chart.dispatchAction({type:'dataZoom', start:sPct, end:ePct});
  syncSlidersWithChart(n);
}
function syncSlidersWithChart(n){
  const dz = chart.getOption().dataZoom[1]; if(!dz) return;
  const s=document.getElementById('sStart'), m=document.getElementById('sMid'), e=document.getElementById('sEnd');
  s.oninput=null; m.oninput=null; e.oninput=null;
  s.value=Math.round(dz.start); e.value=Math.round(dz.end);
  const startIdx=Math.round((dz.start/100)*(n-1)), endIdx=Math.round((dz.end/100)*(n-1));
  const midIdx=Math.round((startIdx+endIdx)/2); m.value=Math.round(100*midIdx/(n-1));
  s.oninput=()=> setWindow(Math.round(s.value*(n-1)/100), endIdx, n);
  e.oninput=()=> setWindow(startIdx, Math.round(e.value*(n-1)/100), n);
  m.oninput=()=>{
    const len=Math.max(4, endIdx-startIdx), mid=Math.round(m.value*(n-1)/100);
    const sIdx=Math.max(0, Math.min(mid - Math.floor(len/2), n-5)), eIdx=Math.min(n-1, sIdx+len);
    setWindow(sIdx, eIdx, n);
  };
}
function quickWindow(q){
  const n = chart.getOption().xAxis[0].data.length;
  if (q==='all'){ setWindow(0, n-1, n); return; }
  const d=parseInt(q,10), win=Math.max(5, Math.min(d, n-1));
  setWindow(n-win, n-1, n);
}
</script>
</body>
</html>
