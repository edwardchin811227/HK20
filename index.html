<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>HK20 — 5因子對比（Fused + RS）</title>

<!-- 核心庫 -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>

<style>
:root{
  --bg:#ffffff;--text:#111827;--muted:#6b7280;--border:#e5e7eb;--grid:#d1d5db;
  --fused:#2563eb;--stock:#16a34a;--stockNeg:#ef4444;
  --green-bg:rgba(16,185,129,.10); /* 更淺：避免與線衝突 */
  --range-bg:rgba(148,163,184,.10);
  --red-bg:rgba(239,68,68,.12);
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font:14px/1.55 -apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial}
.wrap{max-width:1280px;margin:0 auto}
.toolbar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;padding:10px 12px;border-bottom:1px solid var(--border);position:sticky;top:0;background:#fff;z-index:2}
.badge{padding:2px 10px;border:1px solid var(--border);border-radius:999px;font-weight:700}
.status.green{color:#065f46;background:#d1fae5;border-color:#a7f3d0}
.status.range{color:#334155;background:#e2e8f0;border-color:#cbd5e1}
.status.red{color:#991b1b;background:#fee2e2;border-color:#fecaca}
.btns button{padding:4px 10px;border:1px solid var(--border);border-radius:8px;background:#fff;cursor:pointer}
.btns button.active{background:#111827;color:#fff;border-color:#111827}
.controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap;padding:8px 12px}
fieldset{border:1px dashed var(--border);padding:6px 10px;border-radius:10px}
legend{padding:0 6px;color:#374151}
small.hint{color:#6b7280}
.selects{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
select{padding:6px 8px;border:1px solid var(--border);border-radius:8px;min-width:180px}
.checkbox{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.checkbox label{display:flex;gap:6px;align-items:center}
.src{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-left:auto}
.src input[type=url]{width:460px;max-width:70vw;padding:6px 8px;border:1px solid var(--border);border-radius:8px}
.src button{padding:6px 10px;border:1px solid var(--border);border-radius:8px;background:#fff;cursor:pointer}
.note{color:#64748b;font-size:12px}
.canvas-box{position:relative;margin:12px;height:60vh;min-height:400px;border:1px solid var(--border);border-radius:12px;overflow:hidden}
#chart{width:100%;height:100%}
.tooltip{position:fixed;pointer-events:none;background:#111827;color:#fff;padding:8px 10px;border-radius:8px;font-size:12px;opacity:0;transition:opacity .12s;max-width:260px;box-shadow:0 8px 20px rgba(0,0,0,.15)}
.sliders{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;align-items:center;margin:12px}
.slider{display:flex;align-items:center;gap:8px}
.slider label{width:46px;text-align:right;color:#374151}
.slider input[type=range]{flex:1;height:28px;-webkit-appearance:none;background:transparent}
.slider input[type=range]::-webkit-slider-runnable-track{height:10px;background:#e5e7eb;border-radius:999px}
.slider input[type=range]::-moz-range-track{height:10px;background:#e5e7eb;border-radius:999px}
.slider input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:22px;height:22px;border-radius:50%;margin-top:-6px;background:#111827;border:2px solid #fff;box-shadow:0 1px 2px rgba(0,0,0,.25)}
.slider.start input[type=range]::-webkit-slider-thumb{background:#059669}
.slider.mid   input[type=range]::-webkit-slider-thumb{background:#2563eb}
.slider.end   input[type=range]::-webkit-slider-thumb{background:#ef4444}
.dot{display:inline-block;width:10px;height:10px;border-radius:50%}
.dot.amber{background:#f59e0b}.dot.red{background:#ef4444}
#msg{color:#f59e0b;margin:4px 12px}
</style>
</head>
<body>
<div class="wrap">
  <div class="toolbar">
    <div id="stateBadge" class="badge">狀態：—</div>

    <div class="btns">
      <button data-win="365">1Y</button>
      <button data-win="180">6M</button>
      <button data-win="90">3M</button>
      <button data-win="30" class="active">1M</button>
      <button data-win="0" id="btnAll">全部</button>
    </div>

    <div class="selects">
      <label>股票：
        <select id="symbolSelect" multiple size="1" title="可多選，預設單選">
          <!-- 動態填入 20 檔 -->
        </select>
      </label>
      <label>Fused 權重：
        <select id="fusedMode">
          <option value="macro" selected>宏觀權重（Fused_macro）</option>
          <option value="equal">等權（Fused_equal）</option>
        </select>
      </label>
    </div>

    <div class="src">
      <span class="note">資料來源：HK20/data/factors.csv + HK20/data/hk20.csv</span>
      <button id="btnRefresh">更新</button>
      <button id="btnReset">重設</button>
    </div>
  </div>

  <div class="controls">
    <fieldset>
      <legend>門檻</legend>
      <label>Green ≥ <input id="thrG" type="number" step="0.01" value="0.5" style="width:70px"></label>
      <label style="margin-left:8px">Red ≤ <input id="thrR" type="number" step="0.01" value="-0.5" style="width:70px"></label>
    </fieldset>

    <fieldset>
      <legend>顯示</legend>
      <div class="checkbox">
        <label><input type="checkbox" id="showBG" checked> 背景著色（Green/Range/Red）</label>
        <label><input type="checkbox" id="showFused" checked> Fused</label>
        <label><input type="checkbox" id="showRS" checked> RS（相對強弱）</label>
        <label><input type="checkbox" id="showDots" checked> 風險 Dots（<span class="dot amber"></span> Amber / <span class="dot red"></span> Red）</label>
        <label><input type="checkbox" id="showNormHSI"> HSI_norm</label>
        <label><input type="checkbox" id="showNormHSTECH"> HSTECH_norm</label>
        <label><input type="checkbox" id="showNormUSDCNH"> USDCNH_norm</label>
        <label><input type="checkbox" id="showNormVHSI"> VHSI_norm</label>
        <label><input type="checkbox" id="showNormBTC"> BTC_norm</label>
      </div>
    </fieldset>

    <div class="checkbox">
      <label><input type="checkbox" id="kbEnable" checked> 鍵盤微調（←/→ ±1 天，Shift＝±5）</label>
    </div>
  </div>

  <div id="msg"></div>

  <div class="canvas-box">
    <div id="chart"></div>
  </div>

  <div class="sliders">
    <div class="slider start"><label>Start</label><input id="sStart" type="range" min="0" max="100" value="0"></div>
    <div class="slider mid"><label>Mid</label><input id="sMid" type="range" min="0" max="100" value="50"></div>
    <div class="slider end"><label>End</label><input id="sEnd" type="range" min="0" max="100" value="100"></div>
  </div>
</div>

<script>
/* =========================
   0) 常量與 DOM 參照
========================= */
const FACTORS_PRIMARY = 'https://raw.githubusercontent.com/edwardchin811227/HK20/main/data/factors.csv';
const FACTORS_FALLBACK = FACTORS_PRIMARY; // 如需 Google Sheets CSV，可改這裡
const HK20_PRIMARY    = 'https://raw.githubusercontent.com/edwardchin811227/HK20/main/data/hk20.csv';
const HK20_FALLBACK   = HK20_PRIMARY;

const el = (id)=>document.getElementById(id);
const chartEl = el('chart');
const chart = echarts.init(chartEl);
const msg = el('msg');
const stateBadge = el('stateBadge');
const btns = Array.from(document.querySelectorAll('.btns button'));
const sStart = el('sStart'), sMid = el('sMid'), sEnd = el('sEnd');
const thrGInput = el('thrG'), thrRInput = el('thrR');
const showBG = el('showBG'), showFused = el('showFused'), showRS = el('showRS');
const showDots = el('showDots');
const showNormHSI=el('showNormHSI'), showNormHSTECH=el('showNormHSTECH'),
      showNormUSDCNH=el('showNormUSDCNH'), showNormVHSI=el('showNormVHSI'), showNormBTC=el('showNormBTC');
const fusedMode = el('fusedMode');
const symbolSelect = el('symbolSelect');
/* 視窗狀態（以索引） */
let ALL_DATES = []; // 全域日期
let WIN = {start:0, end:0}; // [start, end) 右開區間

/* =========================
   1) 小工具
========================= */
const toNum = (x)=>{ const v = Number(x); return Number.isFinite(v) ? v : NaN; };

function parseCSV(text){
  const res = Papa.parse(text, {header:true, dynamicTyping:true, skipEmptyLines:true});
  return res.data.filter(r=>r.Date);
}

async function fetchCSV(url){ const r = await fetch(url, {cache:'no-store'}); if(!r.ok) throw new Error(`HTTP ${r.status}`); return r.text(); }

async function loadWithFallback(primary, fallback){
  try{ return await fetchCSV(primary); }
  catch(e1){ if (fallback && fallback!==primary) return await fetchCSV(fallback); throw e1; }
}

function dtKey(s){ return s; } // 已是 YYYY-MM-DD

/* rolling Z-score：對 x 用最近 eff 天（預設 30；不足用 n；最小 5） */
function rollingZ(x){
  const out = new Array(x.length).fill(NaN);
  for (let i=0;i<x.length;i++){
    const avail = i+1;
    if (avail<5 || !Number.isFinite(x[i])) continue;
    const eff = avail<30 ? avail : Math.min(252, avail);
    let w = x.slice(i-eff+1, i+1).filter(Number.isFinite);
    if (w.length<5) continue;
    const mean = w.reduce((a,b)=>a+b,0)/w.length;
    const sd = Math.sqrt(w.reduce((a,b)=>a+(b-mean)*(b-mean),0)/w.length) || NaN;
    if (!Number.isFinite(sd) || sd===0) continue;
    out[i] = (x[i]-mean)/sd;
  }
  return out;
}

/* 回報：log return（相較前一日） */
function logReturn(arr){
  const out = new Array(arr.length).fill(NaN);
  for (let i=1;i<arr.length;i++){
    const p0 = arr[i-1], p1 = arr[i];
    if (Number.isFinite(p0) && Number.isFinite(p1) && p0>0 && p1>0){
      out[i] = Math.log(p1/p0);
    }
  }
  return out;
}

/* 生成連續區段（用於 markArea 著色） */
function segmentsByState(dates, fused, thrG, thrR){
  const segs = [];
  const labelOf = (s)=> s>=thrG ? 'Green' : (s<=thrR ? 'Red':'Range');
  let curState=null, segStart=0;
  for(let i=0;i<dates.length;i++){
    const st = labelOf(fused[i]);
    if (curState===null){ curState=st; segStart=i; continue; }
    if (st!==curState){ // 斷段
      segs.push({state:curState, i0:segStart, i1:i});
      curState=st; segStart=i;
    }
  }
  if (curState!==null) segs.push({state:curState, i0:segStart, i1:dates.length-1});
  return segs;
}

/* 狀態徽章 */
function badgeFromVal(v, thrG, thrR){
  stateBadge.classList.remove('green','red','range');
  if (!Number.isFinite(v)){ stateBadge.textContent='狀態：—'; return; }
  if (v>=thrG){ stateBadge.classList.add('status','green'); stateBadge.textContent='狀態：Green'; }
  else if (v<=thrR){ stateBadge.classList.add('status','red'); stateBadge.textContent='狀態：Red'; }
  else { stateBadge.classList.add('status','range'); stateBadge.textContent='狀態：Range'; }
}

/* =========================
   2) 載入資料
========================= */
let FACTORS = null; // {dates:[], fused_macro:[], fused_equal:[], norms:{HSI:[],...}}
let HK20 = null;    // {dates:[], symbols:[...], map: {SYM: [] }}

async function loadAll(){
  msg.textContent = '載入中…';
  // factors
  const txtF = await loadWithFallback(FACTORS_PRIMARY, FACTORS_FALLBACK);
  const rowsF = parseCSV(txtF);
  const datesF = rowsF.map(r=>r.Date);
  const F_macro = rowsF.map(r=>toNum(r.Fused_macro));
  const F_equal = rowsF.map(r=>toNum(r.Fused_equal));
  const norms = {
    HSI: rowsF.map(r=>toNum(r.HSI_norm)),
    HSTECH: rowsF.map(r=>toNum(r.HSTECH_norm)),
    USDCNH: rowsF.map(r=>toNum(r.USDCNH_norm)),
    VHSI: rowsF.map(r=>toNum(r.VHSI_norm)),
    BTC: rowsF.map(r=>toNum(r.BTC_norm))
  };
  FACTORS = {dates:datesF, fused_macro:F_macro, fused_equal:F_equal, norms};

  // hk20
  const txtS = await loadWithFallback(HK20_PRIMARY, HK20_FALLBACK);
  const rowsS = parseCSV(txtS);
  const datesS = rowsS.map(r=>r.Date);
  // symbols = 其餘欄位
  const cols = Object.keys(rowsS[0]||{}).filter(k=>k!=='Date');
  const map = {};
  for (const sym of cols){
    map[sym] = rowsS.map(r=>toNum(r[sym]));
  }
  HK20 = {dates:datesS, symbols:cols, map};

  // 對齊日期：以 factors 為主
  ALL_DATES = FACTORS.dates;
  WIN.start = 0; WIN.end = ALL_DATES.length; // 初始全域
  // 填充下拉
  symbolSelect.innerHTML = '';
  HK20.symbols.forEach((s,i)=>{
    const opt = document.createElement('option');
    opt.value = s; opt.textContent = s;
    symbolSelect.appendChild(opt);
  });
  // 預設單選第一檔
  if (symbolSelect.options.length){
    for (const o of symbolSelect.options){ o.selected = false; }
    symbolSelect.options[0].selected = true;
    symbolSelect.size = 1; // 顯示單行；你可改 size=6 供多選
  }
  // 載入 persisted 設定
  restoreSettings();
  msg.textContent = '';
}

/* =========================
   3) 計算 RS / 準備繪圖資料
========================= */
function sliceByWin(arr){ return arr.slice(WIN.start, WIN.end); }
function alignedSeries(datesBase, datesOther, arrOther){
  // 簡單按日期等長對齊（以 factors 日期為主）
  const idx = new Map(datesOther.map((d,i)=>[d,i]));
  return datesBase.map(d=>{
    const j = idx.get(d);
    return (j==null)? NaN : arrOther[j];
  });
}

function buildChartOption(){
  const thrG = Number(thrGInput.value); const thrR = Number(thrRInput.value);
  const fusedSel = (fusedMode.value==='equal') ? FACTORS.fused_equal : FACTORS.fused_macro;
  const dates = ALL_DATES;
  const fusedAll = fusedSel;

  // Amber/Red dots 位置：用 Fused 值（與主圖同 Y 軸）
  const amber = []; const red = [];
  for (let i=0;i<dates.length;i++){
    const v = fusedAll[i];
    if (!Number.isFinite(v)) { amber.push([i, null]); red.push([i, null]); continue; }
    if (v<=thrR) { red.push([i, v]); amber.push([i, null]); }
    else if (v<thrG && v>thrR) { amber.push([i, v]); red.push([i, null]); }
    else { amber.push([i, null]); red.push([i, null]); }
  }

  // RS 計算：r_stock - r_fused 的 rolling Z
  const r_fused = logReturn(fusedAll);
  const selected = Array.from(symbolSelect.selectedOptions).map(o=>o.value);
  const series = [];

  // 背景著色（用 markArea segment）
  const segs = segmentsByState(dates, fusedAll, thrG, thrR);
  const markAreas = segs.map(seg=>{
    const color = seg.state==='Green' ? 'var(--green-bg)' : (seg.state==='Red'?'var(--red-bg)':'var(--range-bg)');
    return {
      itemStyle:{color},
      xAxis: dates[seg.i0],  // 起
      // 結束要 +1 天，讓區塊覆蓋到 seg.i1
      // echarts 支援用第二個點定義區段：
    };
  }).flat();

  // Fused 主線
  if (showFused.checked){
    series.push({
      type:'line',
      name:'Fused',
      data: fusedAll.map((v,i)=>[dates[i], v]),
      connectNulls:true, showSymbol:false, smooth:true,
      lineStyle:{width:2, color:'var(--fused)'},
      z: 5
    });
  }

  // RS 線（每檔）
  if (showRS.checked && selected.length){
    for (const sym of selected){
      const pxAll = alignedSeries(dates, HK20.dates, HK20.map[sym]);
      const r_sym = logReturn(pxAll);
      const diff = r_sym.map((v,i)=> (Number.isFinite(v)&&Number.isFinite(r_fused[i])) ? (v - r_fused[i]) : NaN);
      const rs = rollingZ(diff);

      // 著色：>0 用 stock（綠）；<0 用紅；可拆成兩條 masked 線
      const pos = rs.map((v,i)=> Number.isFinite(v) && v>0 ? [dates[i], v] : [dates[i], null]);
      const neg = rs.map((v,i)=> Number.isFinite(v) && v<0 ? [dates[i], v] : [dates[i], null]);

      series.push(
        {type:'line', name:`RS+ ${sym}`, data:pos, connectNulls:false, showSymbol:false, smooth:true,
         lineStyle:{width:2, color:'var(--stock)'}, z:6},
        {type:'line', name:`RS- ${sym}`, data:neg, connectNulls:false, showSymbol:false, smooth:true,
         lineStyle:{width:2, color:'var(--stockNeg)'}, z:6}
      );
    }
  }

  // *_norm 額外顯示（預設關）
  const normFlags = {
    HSI: showNormHSI.checked, HSTECH: showNormHSTECH.checked,
    USDCNH: showNormUSDCNH.checked, VHSI: showNormVHSI.checked, BTC: showNormBTC.checked
  };
  for (const fac of Object.keys(normFlags)){
    if (!normFlags[fac]) continue;
    const arr = FACTORS.norms[fac];
    series.push({
      type:'line', name:`${fac}_norm`, data: arr.map((v,i)=>[dates[i], v]),
      connectNulls:true, showSymbol:false, smooth:true,
      lineStyle:{width:1, type:'dashed'}, z:4
    });
  }

  // 風險 Dots（amber / red）
  if (showDots.checked){
    series.push(
      {type:'scatter', name:'Amber', data: amber.map((p,i)=>[dates[i], p[1]]),
       symbolSize:6, itemStyle:{color:'#f59e0b'}, z:8},
      {type:'scatter', name:'Red', data: red.map((p,i)=>[dates[i], p[1]]),
       symbolSize:6, itemStyle:{color:'#ef4444'}, z:8}
    );
  }

  // 視窗切片
  const xAll = dates.slice(WIN.start, WIN.end);

  // 背景 markArea 需要轉成 echarts 的二維區段
  const markAreaData = [];
  if (showBG.checked){
    for (const seg of segs){
      const i0 = Math.max(seg.i0, WIN.start);
      const i1 = Math.min(seg.i1, WIN.end-1);
      if (i1<i0) continue;
      const color = seg.state==='Green' ? 'var(--green-bg)' : (seg.state==='Red'?'var(--red-bg)':'var(--range-bg)');
      markAreaData.push([{xAxis: dates[i0]}, {xAxis: dates[i1], itemStyle:{color}}]);
    }
  }

  // 狀態徽章（取視窗末日 Fused）
  const lastV = fusedAll[WIN.end-1];
  badgeFromVal(lastV, thrG, thrR);

  return {
    tooltip:{
      trigger:'axis',
      axisPointer:{type:'line'},
      formatter:(params)=>{
        const d = params[0] && params[0].axisValueLabel || '';
        const fusedVal = fusedAll[dates.indexOf(d)];
        let state = '—';
        if (Number.isFinite(fusedVal)){
          state = fusedVal>=thrG ? 'Green' : (fusedVal<=thrR ? 'Red' : 'Range');
        }
        let lines = [`<div><b>${d}</b></div>`];
        lines.push(`Fused：${Number.isFinite(fusedVal)? fusedVal.toFixed(3): '—'}（${state}）`);
        // 顯示 RS（只抓當下第一個選中symbol）
        const firstRS = params.find(p=>p.seriesName.startsWith('RS+')||p.seriesName.startsWith('RS-'));
        if (firstRS && Number.isFinite(firstRS.data[1])){
          lines.push(`RS（相對強弱）：${firstRS.data[1].toFixed(3)}`);
        }
        // dots
        const dotTxt = (fusedVal<=thrR) ? 'Red dot' : (fusedVal<thrG && fusedVal>thrR ? 'Amber dot':'—');
        if (showDots.checked) lines.push(`風險點：${dotTxt}`);
        return lines.join('<br/>');
      }
    },
    grid:{left:52,right:28,top:18,bottom:40},
    xAxis:{type:'category', data: xAll, boundaryGap:false, axisLine:{onZero:false}},
    yAxis:{type:'value', scale:true, splitLine:{lineStyle:{color:'#e5e7eb'}}},
    dataZoom:[
      {type:'inside', start:0, end:100},
      {type:'slider', height:18}
    ],
    series: series.map(s=>{
      // 視窗切片
      return {...s, data: s.data.slice(WIN.start, WIN.end)};
    }),
    markArea:{
      silent:true,
      itemStyle:{opacity:1},
      data: markAreaData
    }
  };
}

/* =========================
   4) 渲染 / 交互
========================= */
function render(){
  const opt = buildChartOption();
  chart.setOption(opt, true);
  saveSettings();
}

function applyWinByPercent(){
  // 3 滑桿以百分比對應索引
  const n = ALL_DATES.length;
  const iStart = Math.round((sStart.value/100) * (n-1));
  const iEnd   = Math.round((sEnd.value/100)   * (n-1));
  let s = Math.max(0, Math.min(iStart, iEnd-1));
  let e = Math.min(n, Math.max(iStart+1, iEnd));
  WIN.start = s; WIN.end = e;
  // Mid 合法範圍檢查
  const mid = Math.round((sMid.value/100) * (n-1));
  const winLen = e - s;
  const minMid = Math.floor(winLen/2);
  const maxMid = n - Math.ceil(winLen/2);
  let m = Math.max(minMid, Math.min(mid, maxMid));
  // 依 mid 重新定位 start/end
  const half = Math.floor(winLen/2);
  WIN.start = Math.max(0, m - half);
  WIN.end   = Math.min(n, WIN.start + winLen);
}

function updateSlidersFromWin(){
  const n = ALL_DATES.length, span = (n-1)||1;
  sStart.value = (WIN.start / span) * 100;
  sEnd.value   = ((WIN.end-1) / span) * 100;
  const mid = Math.round((WIN.start + WIN.end -1)/2);
  sMid.value   = (mid / span) * 100;
}

function setQuickWindow(days){
  const n = ALL_DATES.length;
  if (!n) return;
  if (days<=0){ WIN.start=0; WIN.end=n; }
  else {
    const len = Math.max(5, Math.min(days, n)); // 最小視窗=5
    WIN.end = n; WIN.start = Math.max(0, n - len);
  }
  updateSlidersFromWin();
  render();
  btns.forEach(b=>b.classList.toggle('active', Number(b.dataset.win)===days));
}

/* 鍵盤微調 */
document.addEventListener('keydown', (e)=>{
  if(!el('kbEnable').checked) return;
  const n = ALL_DATES.length;
  if (!n) return;
  const step = e.shiftKey ? 5 : 1;
  if (e.key==='ArrowLeft'){
    WIN.start = Math.max(0, WIN.start - step);
    WIN.end   = Math.max(WIN.start+5, WIN.end - step);
    updateSlidersFromWin(); render();
  }else if (e.key==='ArrowRight'){
    WIN.end   = Math.min(n, WIN.end + step);
    WIN.start = Math.min(WIN.end-5, WIN.start + step);
    updateSlidersFromWin(); render();
  }
});

/* 保存/恢復 設定 */
function saveSettings(){
  const set = {
    thrG: thrGInput.value, thrR: thrRInput.value,
    showBG: showBG.checked, showFused: showFused.checked, showRS: showRS.checked, showDots: showDots.checked,
    norms: {HSI:showNormHSI.checked,HSTECH:showNormHSTECH.checked,USDCNH:showNormUSDCNH.checked,VHSI:showNormVHSI.checked,BTC:showNormBTC.checked},
    fusedMode: fusedMode.value,
    win: {startDate: ALL_DATES[WIN.start], endDate: ALL_DATES[WIN.end-1]},
    symbols: Array.from(symbolSelect.selectedOptions).map(o=>o.value)
  };
  localStorage.setItem('hk20_ui', JSON.stringify(set));
}

function restoreSettings(){
  const raw = localStorage.getItem('hk20_ui');
  // 預設
  thrGInput.value = '0.5'; thrRInput.value = '-0.5';
  showBG.checked = true; showFused.checked = true; showRS.checked = true; showDots.checked = true;
  showNormHSI.checked=showNormHSTECH.checked=showNormUSDCNH.checked=showNormVHSI.checked=showNormBTC.checked=false;
  fusedMode.value='macro';
  setQuickWindow(30);

  if (!raw) { render(); return; }
  try{
    const set = JSON.parse(raw);
    if (set.thrG) thrGInput.value = set.thrG;
    if (set.thrR) thrRInput.value = set.thrR;
    if (set.showBG!=null) showBG.checked = set.showBG;
    if (set.showFused!=null) showFused.checked = set.showFused;
    if (set.showRS!=null) showRS.checked = set.showRS;
    if (set.showDots!=null) showDots.checked = set.showDots;
    if (set.norms){
      showNormHSI.checked=!!set.norms.HSI; showNormHSTECH.checked=!!set.norms.HSTECH;
      showNormUSDCNH.checked=!!set.norms.USDCNH; showNormVHSI.checked=!!set.norms.VHSI; showNormBTC.checked=!!set.norms.BTC;
    }
    if (set.fusedMode) fusedMode.value = set.fusedMode;
    // 視窗以日期復原
    if (set.win && set.win.startDate && set.win.endDate){
      const i0 = ALL_DATES.indexOf(set.win.startDate);
      const i1 = ALL_DATES.indexOf(set.win.endDate);
      if (i0>=0 && i1>=i0){
        WIN.start = i0; WIN.end = i1+1;
        updateSlidersFromWin();
      }
    }
    // 選股
    if (set.symbols && set.symbols.length){
      for (const o of symbolSelect.options){ o.selected = set.symbols.includes(o.value); }
      symbolSelect.size = 1; // 想多選可改成 size=6
    }
  }catch(_){}
  render();
}

/* =========================
   5) 綁定事件
========================= */
btns.forEach(b=>{
  b.addEventListener('click', ()=> setQuickWindow(Number(b.dataset.win)));
});
el('btnAll').addEventListener('click', ()=> setQuickWindow(0));

[sStart, sMid, sEnd].forEach(r=>{
  r.addEventListener('input', ()=>{ applyWinByPercent(); render(); });
});

[thrGInput, thrRInput, showBG, showFused, showRS, showDots,
 showNormHSI, showNormHSTECH, showNormUSDCNH, showNormVHSI, showNormBTC,
 fusedMode, symbolSelect].forEach(ctrl=>{
  ctrl.addEventListener('change', ()=> render());
});

el('btnRefresh').addEventListener('click', async ()=>{
  await loadAll(); render();
});
el('btnReset').addEventListener('click', ()=>{
  localStorage.removeItem('hk20_ui');
  setQuickWindow(30);
  restoreSettings();
});

/* =========================
   6) 啟動
========================= */
(async function init(){
  try{
    await loadAll();
    // 初始選 1M
    setQuickWindow(30);
  }catch(err){
    console.error(err);
    msg.textContent = '讀取失敗：請檢查 data/factors.csv 與 data/hk20.csv 是否可公開讀取。';
  }
})();
</script>
</body>
</html>
