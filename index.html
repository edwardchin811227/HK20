<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>HK20 • Risk ON/OFF + RS</title>

<!-- ECharts + PapaParse -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
:root{
  --bg:#fff; --text:#111827; --muted:#6b7280; --border:#e5e7eb; --chip:#f3f4f6;
  --green:#10b981; --amber:#f59e0b; --red:#ef4444; --blue:#2563eb;
  --bg-green: rgba(16,185,129,.10);
  --bg-range: rgba(107,114,128,.10);
  --bg-red: rgba(239,68,68,.10);
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial}
.wrap{max-width:1280px;margin:0 auto;padding:16px}
.toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:10px}
.pill{padding:6px 12px;border-radius:999px;border:1px solid var(--border);background:#fff;display:inline-flex;gap:8px;align-items:center}
.pill input, .pill select{padding:6px 10px;border:1px solid var(--border);border-radius:8px;min-width:90px}
.pill .btn{padding:6px 10px;border:1px solid var(--border);border-radius:8px;background:#fff;cursor:pointer}
.pill .btn.active{background:#111827;color:#fff;border-color:#111827}
.badge{font-weight:700;border-radius:999px;padding:6px 12px}
.badge.green{color:#065f46;background:#d1fae5;border:1px solid #a7f3d0}
.badge.range{color:#334155;background:#e2e8f0;border:1px solid #cbd5e1}
.badge.red{color:#7f1d1d;background:#fee2e2;border:1px solid #fecaca}
.switch{display:flex;gap:8px;align-items:center;border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:#fff}
.chk{display:flex;gap:6px;align-items:center}
.legend{display:flex;gap:16px;align-items:center;color:var(--muted)}
.dot{width:8px;height:8px;border-radius:999px;display:inline-block;margin-right:6px}
.cGreen{background:var(--green)} .cAmber{background:var(--amber)} .cRed{background:var(--red)} .cBlue{background:var(--blue)}
#chart{height:560px}
small{color:var(--muted)}
hr{border:none;border-top:1px solid var(--border);margin:8px 0}
@media (max-width:720px){ #chart{height:480px} }
</style>
</head>
<body>
<div class="wrap">

  <!-- 狀態 -->
  <div class="toolbar">
    <span id="stateBadge" class="badge range">Range</span>

    <div class="pill" id="rangeBtns">
      <button class="btn" data-range="1Y">1Y</button>
      <button class="btn active" data-range="6M">6M</button>
      <button class="btn" data-range="3M">3M</button>
      <button class="btn" data-range="1M">1M</button>
    </div>

    <div class="pill">
      <label>股票：</label>
      <select id="stockSel">
        <!-- 20 檔（照你的 repo 常用的）-->
        <option>00700</option><option>09988</option><option>03690</option><option>01024</option><option>01810</option>
        <option>09618</option><option>00388</option><option>02318</option><option>03988</option><option>00939</option>
        <option>09888</option><option>00005</option><option>01211</option><option>09999</option><option>09626</option>
        <option>09961</option><option>01398</option><option>00857</option><option>00883</option><option>00981</option>
      </select>
    </div>

    <div class="pill">
      <label>Fused 權重：</label>
      <select id="wSel">
        <option value="equal">等權（Fused_equal）</option>
        <option value="macro">宏觀（Fused_macro）</option>
      </select>
    </div>

    <div class="pill">
      <button id="btnRefresh" class="btn">更新</button>
      <button id="btnReset" class="btn">重設</button>
    </div>
  </div>

  <!-- 門檻 -->
  <div class="toolbar">
    <div class="pill">
      <label>Green ≥</label>
      <input id="thGreen" type="number" step="0.05" value="0.50">
      <label style="margin-left:8px">Red ≤</label>
      <input id="thRed" type="number" step="0.05" value="-0.5">
      <small>（即時調整門檻，背景同步改變）</small>
    </div>

    <div class="switch">
      <label class="chk"><input type="checkbox" id="bgChk" checked> 背景著色（Green/Range/Red）</label>
      <label class="chk"><input type="checkbox" id="fusedChk" checked> Fused</label>
      <label class="chk"><input type="checkbox" id="rsChk" checked> RS（相對強弱）</label>
      <label class="chk"><input type="checkbox" id="dotsChk" checked> 風險 Dots（<span style="color:var(--amber)">Amber 上</span> / <span style="color:var(--red)">Red 下</span>）</label>
    </div>
  </div>

  <div class="legend">
    <span><i class="dot cBlue"></i>Fused / RS</span>
    <span><i class="dot cAmber"></i>Amber</span>
    <span><i class="dot cRed"></i>Red</span>
  </div>

  <div id="chart"></div>
  <small>資料來源：HK20/data/factors.csv（primary）＋ HK20/data/hk20.csv（fallback）</small>
</div>

<script>
/* -----------------------------
 * 1) 設定：資料來源（primary + fallback）
 * ----------------------------- */
const CSV_FACTORS  = 'https://raw.githubusercontent.com/edwardchin811227/HK20/main/data/factors.csv';
const CSV_HK20     = 'https://raw.githubusercontent.com/edwardchin811227/HK20/main/data/hk20.csv';

const $ = s => document.querySelector(s);
const chart = echarts.init($('#chart'));

/* -----------------------------
 * 2) 小工具
 * ----------------------------- */
const toNum = v => {
  const x = Number(v);
  return Number.isFinite(x) ? x : NaN;
};

// 線性插值（避免 RS 斷斷續續）
function linInterp(arr){
  const y = arr.slice();
  let last = null;
  for(let i=0;i<y.length;i++){
    if(Number.isFinite(y[i])) last = i;
    else{
      // 找下一個非 NaN
      let j=i+1; while(j<y.length && !Number.isFinite(y[j])) j++;
      if(last!==null && j<y.length){
        const a = y[last], b = y[j], span = j-last;
        for(let k=1;k<span;k++) y[last+k] = a + (b-a)*k/span;
        i = j;
      }
    }
  }
  return y;
}

// rolling mean
function sma(xs, n){
  const out = new Array(xs.length).fill(NaN);
  let sum = 0, q = [];
  for(let i=0;i<xs.length;i++){
    const v = xs[i];
    if(Number.isFinite(v)){
      q.push(v); sum += v;
      if(q.length>n){ sum -= q.shift(); }
      if(q.length===n) out[i] = sum/n;
    }else{
      q.length = 0; sum = 0; // 遇到缺值就重置，以免污染
    }
  }
  return out;
}

/* -----------------------------
 * 3) 載入 CSV + 合併
 * ----------------------------- */
async function fetchCSV(url){
  const r = await fetch(url, {cache:'no-store'});
  if(!r.ok) throw new Error('HTTP '+r.status);
  return await r.text();
}
function parseCSV(text){
  return new Promise((resolve,reject)=>{
    Papa.parse(text,{header:true,dynamicTyping:true,skipEmptyLines:true,complete:res=>resolve(res.data),error:reject});
  });
}
async function loadAll(){
  // 先 factors（有 Fused、*_norm）
  try{
    const t1 = await fetchCSV(CSV_FACTORS);
    var factors = await parseCSV(t1);
  }catch(e){
    // fallback only for stocks
    factors = null;
  }
  // 再 hk20（20 檔 close）
  try{
    const t2 = await fetchCSV(CSV_HK20);
    var hk20 = await parseCSV(t2);
  }catch(e){
    hk20 = [];
  }
  return {factors, hk20};
}

/* -----------------------------
 * 4) 主流程：計算 RS / 風險 dots / 背景區塊
 * ----------------------------- */
function buildSeries(rows, opt){
  // rows 來自 factors（含 *_norm + Fused_*），日期格式 YYYY-MM-DD
  const G = Number($('#thGreen').value);
  const R = Number($('#thRed').value);
  const showBG   = $('#bgChk').checked;
  const showFused= $('#fusedChk').checked;
  const showRS   = $('#rsChk').checked;
  const showDots = $('#dotsChk').checked;

  // 權重版本
  const fusedKey = ($('#wSel').value==='macro') ? 'Fused_macro' : 'Fused_equal';

  // x 軸
  const dates = rows.map(r => r.Date);

  // fused / 各指標
  const fused = rows.map(r => toNum(r[fusedKey]));

  // RS 計法（相對強弱）：用「股票當天收盤 / 自身 60d SMA」-1，再做 15d 平滑
  // （股票的 close 從 hk20.csv 取；沒資料時 RS=NaN）
  const code = $('#stockSel').value;
  const close = rows.map(r => toNum(r[code]));          // 把 hk20 的同名欄位 merge 到 factors 前了（在 main() 做）
  // 60d SMA
  const c60 = sma(close, 60);
  const rsRaw = close.map((c,i)=> Number.isFinite(c)&&Number.isFinite(c60[i]) ? (c/c60[i]-1) : NaN);
  // 平滑（15d）
  const rsSmooth = sma(rsRaw, 15);
  // 線性補內插，避免斷線
  const rs = linInterp(rsSmooth);

  // 背景區塊（Green / Range / Red）
  let areas = [];
  if(showBG){
    // 三段門檻：fused >= G → Green； fused <= R → Red； 其餘 Range
    let curType = null, start = 0;
    function pushArea(type, s, e){
      if(e<=s) return;
      let color = 'rgba(0,0,0,0)';
      if(type==='G') color = getComputedStyle(document.documentElement).getPropertyValue('--bg-green');
      if(type==='N') color = getComputedStyle(document.documentElement).getPropertyValue('--bg-range');
      if(type==='R') color = getComputedStyle(document.documentElement).getPropertyValue('--bg-red');
      areas.push({
        name: (type==='G'?'Green':type==='R'?'Red':'Range'),
        itemStyle:{color},
        xAxis:[dates[s], dates[e-1]]
      });
    }
    for(let i=0;i<dates.length;i++){
      const f = fused[i];
      const t = Number.isFinite(f) ? (f>=G?'G':(f<=R?'R':'N')) : curType;
      if(curType==null){ curType=t; start=i; continue; }
      if(t!==curType){ pushArea(curType,start,i); curType=t; start=i; }
      if(i===dates.length-1) pushArea(curType,start,i+1);
    }
  }

  // 風險 dots：Amber 在上（rs 高於 0 → 這裡用 rs > 0 做示意），Red 在下（rs < 0）
  // 你可以改成更嚴苛的門檻（例如 > +0.02 / < -0.02）
  const amber = [], red = [];
  if(showDots){
    for(let i=0;i<dates.length;i++){
      const v = rs[i];
      if(!Number.isFinite(v)) continue;
      if(v >= 0) amber.push([dates[i], v + 0.03]); // 放「上面」一點
      else       red.push([dates[i], v - 0.03]);   // 放「下面」一點
    }
  }

  // 狀態 pill
  const lastF = fused.at(-1);
  const state = Number.isFinite(lastF) ? (lastF>=G?'green':(lastF<=R?'red':'range')) : 'range';
  const badge = $('#stateBadge');
  badge.className = 'badge '+state;
  badge.textContent = state==='green'?'Green':state==='red'?'Red':'Range';

  // ECharts series 組裝
  const series = [];

  // 背景分區（用 markArea，層級最低，不遮滑鼠線）
  if(showBG && areas.length){
    series.push({
      type:'line',
      name:'BG',
      data: fused.map(_=>NaN),
      markArea:{
        silent:true,
        itemStyle:{opacity:1},
        data: areas.map(a=>[{xAxis:a.xAxis[0],itemStyle:{color:a.itemStyle.color}},{xAxis:a.xAxis[1]}])
      },
      lineStyle:{opacity:0}, symbol:'none', z:0, zlevel:0
    });
  }

  if(showFused){
    series.push({
      type:'line', name:'Fused',
      data: fused, symbol:'none',
      lineStyle:{width:2,color:getComputedStyle(document.documentElement).getPropertyValue('--blue')},
      z:3
    });
  }

  if(showRS){
    series.push({
      type:'line', name:'RS',
      data: rs, symbol:'none',
      lineStyle:{width:2,color:'#8da2fb',type:'dashed'},
      z:3
    });
  }

  if(showDots && amber.length){
    series.push({
      type:'scatter', name:'Amber',
      data: amber, symbolSize:6,
      itemStyle:{color:getComputedStyle(document.documentElement).getPropertyValue('--amber').trim()},
      z:4
    });
  }
  if(showDots && red.length){
    series.push({
      type:'scatter', name:'Red',
      data: red, symbolSize:6,
      itemStyle:{color:getComputedStyle(document.documentElement).getPropertyValue('--red').trim()},
      z:4
    });
  }

  return {series, dates};
}

/* -----------------------------
 * 5) 畫圖 + 交互
 * ----------------------------- */
let RAW = {factors:null, hk20:null};
let merged = [];     // factors + 20 檔 close 合併後（照日期）
let currentRange = '6M';

function mergeRows(factors, hk20){
  if(!factors) return [];
  // 把 20 檔 close 合併到 factors（以 Date 對齊）
  // hk20 的每欄就是一個 code（00700...）
  const map = new Map(hk20.map(r => [r.Date, r]));
  return factors.map(r=>{
    const extra = map.get(r.Date)||{};
    return {...extra, ...r}; // 以 factors 欄位為主（含 *_norm, Fused_*）
  }).filter(r=>r.Date);
}

function applyRange(dates){
  const n = dates.length;
  let keep = n;
  if(currentRange==='1Y') keep = Math.min(n, 260);
  if(currentRange==='6M') keep = Math.min(n, 130);
  if(currentRange==='3M') keep = Math.min(n, 65);
  if(currentRange==='1M') keep = Math.min(n, 22);
  return Math.max(0, n-keep);
}

function render(){
  if(!merged.length) return;
  const {series, dates} = buildSeries(merged);
  const startIdx = applyRange(dates);

  chart.setOption({
    animation:false,
    tooltip:{trigger:'axis'},
    dataZoom:[{type:'inside',startValue:startIdx,endValue:dates.length-1},{type:'slider'}],
    xAxis:{type:'category',data:dates,axisLabel:{color:'#6b7280'}},
    yAxis:{type:'value',axisLabel:{color:'#6b7280'}},
    series
  }, true);
}

async function main(){
  RAW = await loadAll();
  merged = mergeRows(RAW.factors||[], RAW.hk20||[]);
  render();
}

/* -----------------------------
 * 6) 事件
 * ----------------------------- */
$('#btnRefresh').addEventListener('click', main);
$('#btnReset').addEventListener('click', ()=>{
  $('#thGreen').value = 0.50;
  $('#thRed').value   = -0.5;
  $('#bgChk').checked = true;
  $('#fusedChk').checked = true;
  $('#rsChk').checked  = true;
  $('#dotsChk').checked= true;
  currentRange = '6M';
  document.querySelectorAll('#rangeBtns .btn').forEach(b=>b.classList.toggle('active', b.dataset.range==='6M'));
  render();
});
['#thGreen','#thRed','#bgChk','#fusedChk','#rsChk','#dotsChk','#wSel','#stockSel']
  .forEach(sel => $(sel).addEventListener('change', render));

document.querySelectorAll('#rangeBtns .btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('#rangeBtns .btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    currentRange = btn.dataset.range;
    render();
  });
});

main();
</script>
</body>
</html>
